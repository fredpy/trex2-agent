<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>trex: extra/europa2.old/Assembly.cc Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='../../open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='../../closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='../../closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="../../main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../dirs.html"><span>Directories</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="../../files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="../../globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="../../dir_a032f23e96409494e74a59edbe6bc8e5.html">extra</a>&nbsp;&raquo;&nbsp;<a class="el" href="../../dir_aadc07d4d9c472d12b4c06eadec554c7.html">europa2.old</a>
  </div>
</div>
<div class="contents">
<h1>Assembly.cc</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*********************************************************************</span>
<a name="l00002"></a>00002 <span class="comment"> * Software License Agreement (BSD License)</span>
<a name="l00003"></a>00003 <span class="comment"> * </span>
<a name="l00004"></a>00004 <span class="comment"> *  Copyright (c) 2011, MBARI.</span>
<a name="l00005"></a>00005 <span class="comment"> *  All rights reserved.</span>
<a name="l00006"></a>00006 <span class="comment"> * </span>
<a name="l00007"></a>00007 <span class="comment"> *  Redistribution and use in source and binary forms, with or without</span>
<a name="l00008"></a>00008 <span class="comment"> *  modification, are permitted provided that the following conditions</span>
<a name="l00009"></a>00009 <span class="comment"> *  are met:</span>
<a name="l00010"></a>00010 <span class="comment"> * </span>
<a name="l00011"></a>00011 <span class="comment"> *   * Redistributions of source code must retain the above copyright</span>
<a name="l00012"></a>00012 <span class="comment"> *     notice, this list of conditions and the following disclaimer.</span>
<a name="l00013"></a>00013 <span class="comment"> *   * Redistributions in binary form must reproduce the above</span>
<a name="l00014"></a>00014 <span class="comment"> *     copyright notice, this list of conditions and the following</span>
<a name="l00015"></a>00015 <span class="comment"> *     disclaimer in the documentation and/or other materials provided</span>
<a name="l00016"></a>00016 <span class="comment"> *     with the distribution.</span>
<a name="l00017"></a>00017 <span class="comment"> *   * Neither the name of the TREX Project nor the names of its</span>
<a name="l00018"></a>00018 <span class="comment"> *     contributors may be used to endorse or promote products derived</span>
<a name="l00019"></a>00019 <span class="comment"> *     from this software without specific prior written permission.</span>
<a name="l00020"></a>00020 <span class="comment"> * </span>
<a name="l00021"></a>00021 <span class="comment"> *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<a name="l00022"></a>00022 <span class="comment"> *  &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<a name="l00023"></a>00023 <span class="comment"> *  LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</span>
<a name="l00024"></a>00024 <span class="comment"> *  FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE</span>
<a name="l00025"></a>00025 <span class="comment"> *  COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<a name="l00026"></a>00026 <span class="comment"> *  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span>
<a name="l00027"></a>00027 <span class="comment"> *  BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;</span>
<a name="l00028"></a>00028 <span class="comment"> *  LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span>
<a name="l00029"></a>00029 <span class="comment"> *  CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
<a name="l00030"></a>00030 <span class="comment"> *  LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN</span>
<a name="l00031"></a>00031 <span class="comment"> *  ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<a name="l00032"></a>00032 <span class="comment"> *  POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00033"></a>00033 <span class="comment"> */</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;EuropaReactor.hh&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;DbSolver.hh&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;Constraints.hh&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;DeliberationFilter.hh&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;Synchronizer.hh&quot;</span>
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;bits/europa_types.hh&quot;</span>
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;private/Schema.hh&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;private/ReactorPropagator.hh&quot;</span>
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;PLASMA/ModuleConstraintEngine.hh&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;PLASMA/ModulePlanDatabase.hh&gt;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;PLASMA/ModuleRulesEngine.hh&gt;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &lt;PLASMA/ModuleTemporalNetwork.hh&gt;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;PLASMA/ModuleSolvers.hh&gt;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &lt;PLASMA/ModuleNddl.hh&gt;</span>
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 <span class="preprocessor">#include &lt;PLASMA/RulesEngine.hh&gt;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &lt;PLASMA/Propagators.hh&gt;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &lt;PLASMA/Schema.hh&gt;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &lt;PLASMA/NddlInterpreter.hh&gt;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &lt;PLASMA/TokenVariable.hh&gt;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &lt;PLASMA/Timeline.hh&gt;</span>
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 <span class="preprocessor">#include &lt;boost/algorithm/string/replace.hpp&gt;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &lt;boost/bind.hpp&gt;</span>
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 <span class="keyword">using namespace </span>TREX::europa;
<a name="l00063"></a>00063 <span class="keyword">using namespace </span>TREX::transaction;
<a name="l00064"></a>00064 <span class="keyword">using namespace </span>TREX::utils;
<a name="l00065"></a>00065 
<a name="l00066"></a>00066 <span class="keyword">namespace </span>xml = boost::property_tree::xml_parser;
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 <span class="keyword">namespace </span>{
<a name="l00069"></a>00069   
<a name="l00070"></a>00070   <span class="keyword">class </span>DefaultSchema :<span class="keyword">public</span> <a class="code" href="../../d9/dab/classTREX_1_1europa_1_1SchemaPlugin.html" title="Europa extension &amp;quot;plug-in&amp;quot;.">SchemaPlugin</a> {
<a name="l00071"></a>00071   <span class="keyword">public</span>:
<a name="l00072"></a>00072     
<a name="l00073"></a>00073     <span class="keywordtype">void</span> registerComponents(<a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html" title="Interface toward europa.">Assembly</a> <span class="keyword">const</span> &amp;assembly) {
<a name="l00074"></a>00074       <span class="comment">// declare the filter used for maintaining reactor look-ahead</span>
<a name="l00075"></a>00075       TREX_REGISTER_FLAW_FILTER(assembly, <a class="code" href="../../d6/dc0/classTREX_1_1europa_1_1DeliberationFilter.html">TREX::europa::DeliberationFilter</a>,
<a name="l00076"></a>00076                                 <a class="code" href="../../d6/dc0/classTREX_1_1europa_1_1DeliberationFilter.html">DeliberationFilter</a>);
<a name="l00077"></a>00077       <span class="comment">// declare few TREX utility constraints</span>
<a name="l00078"></a>00078       TREX_REGISTER_CONSTRAINT(assembly, <a class="code" href="../../d3/d09/classTREX_1_1europa_1_1CheckExternal.html" title="Check if External.">TREX::europa::CheckExternal</a>, isExternal, trex);
<a name="l00079"></a>00079       TREX_REGISTER_CONSTRAINT(assembly, <a class="code" href="../../db/d52/classTREX_1_1europa_1_1CheckInternal.html" title="Check if Internal.">TREX::europa::CheckInternal</a>, isInternal, trex);
<a name="l00080"></a>00080       TREX_REGISTER_CONSTRAINT(assembly, <a class="code" href="../../d2/d95/classTREX_1_1europa_1_1Bind.html" title="Variable binding constraint.">TREX::europa::Bind</a>, bind, trex);      
<a name="l00081"></a>00081     }
<a name="l00082"></a>00082     
<a name="l00083"></a>00083   }; <span class="comment">// ::DefaultSchema</span>
<a name="l00084"></a>00084   
<a name="l00085"></a>00085   
<a name="l00086"></a>00086   DefaultSchema trex_schema;
<a name="l00087"></a>00087 } <span class="comment">// ::</span>
<a name="l00088"></a>00088 
<a name="l00089"></a>00089 
<a name="l00090"></a>00090 <span class="comment">/*</span>
<a name="l00091"></a>00091 <span class="comment"> * class TREX::europa::TokenError</span>
<a name="l00092"></a>00092 <span class="comment"> */</span> 
<a name="l00093"></a>00093 
<a name="l00094"></a>00094 TokenError::TokenError(EUROPA::Token <span class="keyword">const</span> &amp;tok, std::string <span class="keyword">const</span> &amp;msg) <span class="keywordflow">throw</span>()
<a name="l00095"></a>00095   :<a class="code" href="../../dd/d3e/classTREX_1_1europa_1_1EuropaException.html" title="Europa related error.">EuropaException</a>(msg+<span class="stringliteral">&quot;; on token:\n\t&quot;</span>+tok.toLongString()) {}
<a name="l00096"></a>00096 
<a name="l00097"></a>00097 <span class="comment">/*</span>
<a name="l00098"></a>00098 <span class="comment"> * class TREX::europa::Assembly</span>
<a name="l00099"></a>00099 <span class="comment"> */</span>
<a name="l00100"></a>00100 
<a name="l00101"></a>00101 <span class="comment">// statics</span>
<a name="l00102"></a>00102 
<a name="l00103"></a>00103 EUROPA::LabelStr <span class="keyword">const</span> Assembly::TREX_TIMELINE(<span class="stringliteral">&quot;AgentTimeline&quot;</span>);
<a name="l00104"></a>00104 
<a name="l00105"></a>00105 std::string <span class="keyword">const</span>       Assembly::DEFAULT_ATTR(<span class="stringliteral">&quot;defaultPredicate&quot;</span>);
<a name="l00106"></a>00106 std::string <span class="keyword">const</span>        Assembly::UNDEFINED_PRED(<span class="stringliteral">&quot;undefined&quot;</span>);
<a name="l00107"></a>00107 
<a name="l00108"></a>00108 std::string <span class="keyword">const</span>       Assembly::MODE_ATTR(<span class="stringliteral">&quot;mode&quot;</span>);
<a name="l00109"></a>00109 EUROPA::LabelStr <span class="keyword">const</span>   Assembly::EXTERNAL_MODE(<span class="stringliteral">&quot;External&quot;</span>);
<a name="l00110"></a>00110 EUROPA::LabelStr <span class="keyword">const</span>   Assembly::OBSERVE_MODE(<span class="stringliteral">&quot;Observe&quot;</span>);
<a name="l00111"></a>00111 EUROPA::LabelStr <span class="keyword">const</span>   Assembly::INTERNAL_MODE(<span class="stringliteral">&quot;Internal&quot;</span>);
<a name="l00112"></a>00112 EUROPA::LabelStr <span class="keyword">const</span>   Assembly::PRIVATE_MODE(<span class="stringliteral">&quot;Private&quot;</span>);
<a name="l00113"></a>00113 EUROPA::LabelStr <span class="keyword">const</span>   Assembly::IGNORE_MODE(<span class="stringliteral">&quot;Ignore&quot;</span>);
<a name="l00114"></a>00114 
<a name="l00115"></a>00115 EUROPA::LabelStr <span class="keyword">const</span> Assembly::MISSION_END(<span class="stringliteral">&quot;MISSION_END&quot;</span>);
<a name="l00116"></a>00116 
<a name="l00117"></a>00117 EUROPA::LabelStr <span class="keyword">const</span> Assembly::TICK_DURATION(<span class="stringliteral">&quot;TICK_DURATION&quot;</span>);
<a name="l00118"></a>00118 
<a name="l00119"></a>00119 EUROPA::LabelStr <span class="keyword">const</span> Assembly::CLOCK_VAR(<span class="stringliteral">&quot;AGENT_CLOCK&quot;</span>);
<a name="l00120"></a>00120 
<a name="l00121"></a>00121 std::string Assembly::predicate_name(EUROPA::ObjectId <span class="keyword">const</span> &amp;obj, 
<a name="l00122"></a>00122                                      std::string <span class="keyword">const</span> &amp;pred) {
<a name="l00123"></a>00123   <span class="keywordflow">return</span> obj-&gt;getType().toString()+<span class="stringliteral">&quot;.&quot;</span>+pred;
<a name="l00124"></a>00124 }
<a name="l00125"></a>00125 
<a name="l00126"></a>00126 
<a name="l00127"></a>00127 <span class="comment">// structors </span>
<a name="l00128"></a>00128 
<a name="l00129"></a>00129 Assembly::Assembly(<a class="code" href="../../d5/dba/classTREX_1_1europa_1_1EuropaReactor.html" title="Europa based deliberative reactor.">EuropaReactor</a> &amp;owner):m_state(INACTIVE), m_reactor(owner), m_filter(NULL) {
<a name="l00130"></a>00130   <span class="comment">// Create the europa debug output file</span>
<a name="l00131"></a>00131   m_trex_schema-&gt;setStream(m_debug, name().str()+<span class="stringliteral">&quot;.europa.log&quot;</span>);
<a name="l00132"></a>00132   
<a name="l00133"></a>00133   <span class="comment">// Create the europa modules we need</span>
<a name="l00134"></a>00134   addModule((<span class="keyword">new</span> EUROPA::ModuleConstraintEngine())-&gt;getId());
<a name="l00135"></a>00135   addModule((<span class="keyword">new</span> EUROPA::ModuleConstraintLibrary())-&gt;getId());
<a name="l00136"></a>00136   addModule((<span class="keyword">new</span> EUROPA::ModulePlanDatabase())-&gt;getId());
<a name="l00137"></a>00137   addModule((<span class="keyword">new</span> EUROPA::ModuleRulesEngine())-&gt;getId());
<a name="l00138"></a>00138   addModule((<span class="keyword">new</span> EUROPA::ModuleTemporalNetwork())-&gt;getId());
<a name="l00139"></a>00139   addModule((<span class="keyword">new</span> EUROPA::ModuleSolvers())-&gt;getId());
<a name="l00140"></a>00140   addModule((<span class="keyword">new</span> EUROPA::ModuleNddl())-&gt;getId());
<a name="l00141"></a>00141   
<a name="l00142"></a>00142   doStart();
<a name="l00143"></a>00143 
<a name="l00144"></a>00144   <span class="comment">// Collect europa entry points</span>
<a name="l00145"></a>00145   m_europa_schema = <span class="keyword">dynamic_cast&lt;</span>EUROPA::Schema *<span class="keyword">&gt;</span>(getComponent(<span class="stringliteral">&quot;Schema&quot;</span>))-&gt;getId();
<a name="l00146"></a>00146   m_cstr_engine = <span class="keyword">dynamic_cast&lt;</span>EUROPA::ConstraintEngine *<span class="keyword">&gt;</span>(getComponent(<span class="stringliteral">&quot;ConstraintEngine&quot;</span>))-&gt;getId();
<a name="l00147"></a>00147   m_plan_db = <span class="keyword">dynamic_cast&lt;</span>EUROPA::PlanDatabase *<span class="keyword">&gt;</span>(getComponent(<span class="stringliteral">&quot;PlanDatabase&quot;</span>))-&gt;getId();
<a name="l00148"></a>00148   m_rules_engine = <span class="keyword">dynamic_cast&lt;</span>EUROPA::RulesEngine *<span class="keyword">&gt;</span>(getComponent(<span class="stringliteral">&quot;RulesEngine&quot;</span>))-&gt;getId();
<a name="l00149"></a>00149   
<a name="l00150"></a>00150   <span class="comment">// Configure my constraint engine</span>
<a name="l00151"></a>00151   <span class="keyword">new</span> <a class="code" href="../../d9/da5/classTREX_1_1europa_1_1ReactorPropagator.html" title="TREX specific propagator.">ReactorPropagator</a>(*<span class="keyword">this</span>, EUROPA::LabelStr(<span class="stringliteral">&quot;trex&quot;</span>), m_cstr_engine);
<a name="l00152"></a>00152   m_cstr_engine-&gt;setAutoPropagation(<span class="keyword">false</span>);
<a name="l00153"></a>00153   
<a name="l00154"></a>00154   <span class="comment">// Inject extensions </span>
<a name="l00155"></a>00155   m_trex_schema-&gt;registerComponents(*<span class="keyword">this</span>);
<a name="l00156"></a>00156   
<a name="l00157"></a>00157   EUROPA::DomainComparator::setComparator((EUROPA::Schema *)m_europa_schema);
<a name="l00158"></a>00158   
<a name="l00159"></a>00159   <span class="comment">// Create my TokenManager that will listen to token events in the plan</span>
<a name="l00160"></a>00160   m_tokens.reset(<span class="keyword">new</span> <a class="code" href="../../d6/d70/classTREX_1_1europa_1_1TokenManager.html">TokenManager</a>(*<span class="keyword">this</span>));
<a name="l00161"></a>00161 }
<a name="l00162"></a>00162 
<a name="l00163"></a>00163 Assembly::~Assembly() {
<a name="l00164"></a>00164   doShutdown();
<a name="l00165"></a>00165 }
<a name="l00166"></a>00166 
<a name="l00167"></a>00167 <span class="comment">// observers</span>
<a name="l00168"></a>00168 
<a name="l00169"></a>00169 <a class="code" href="../../dc/de0/classTREX_1_1utils_1_1BasicSymbol.html" title="generic symbol class">Symbol</a> Assembly::name()<span class="keyword"> const </span>{
<a name="l00170"></a>00170   <span class="keywordflow">return</span> m_reactor.<a class="code" href="../../df/d7a/classTREX_1_1transaction_1_1TeleoReactor.html#a8facf8e8ea1ba386fa07bffb25881379" title="Reactor name.">getName</a>();
<a name="l00171"></a>00171 }
<a name="l00172"></a>00172 
<a name="l00173"></a>00173 EUROPA::eint Assembly::currentTick()<span class="keyword"> const </span>{
<a name="l00174"></a>00174   <span class="keywordflow">return</span> EUROPA::eint(m_reactor.<a class="code" href="../../df/d7a/classTREX_1_1transaction_1_1TeleoReactor.html#ae8ea840f31e81735b8b0481f0608d535" title="Get current tick.">getCurrentTick</a>());
<a name="l00175"></a>00175 }
<a name="l00176"></a>00176 
<a name="l00177"></a>00177 
<a name="l00178"></a>00178 <span class="keywordtype">void</span> <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a89f8c5ced5458f76a4a0b3000d16c9df" title="Get trex timelines.">Assembly::trex_timelines</a>(std::list&lt;EUROPA::ObjectId&gt; &amp;timelines)<span class="keyword"> const </span>{
<a name="l00179"></a>00179   <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a4b1156d1afeaaa97638ba63025b1ff02" title="Get europa plan database.">plan_db</a>()-&gt;getObjectsByType(<a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#ad095f7f9e7d1a5cc8e25c4de95c64317" title="TREX agent timelines.">TREX_TIMELINE</a>, timelines);
<a name="l00180"></a>00180 }
<a name="l00181"></a>00181 
<a name="l00182"></a>00182 <span class="keywordtype">bool</span> Assembly::isAgentTimeline(EUROPA::ObjectId <span class="keyword">const</span> &amp;obj)<span class="keyword"> const </span>{
<a name="l00183"></a>00183   <span class="keywordflow">return</span> <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#acefaf2dd910ec5609ad7c682649507f9" title="Get europa schema.">schema</a>()-&gt;isA(obj-&gt;getType(), <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#ad095f7f9e7d1a5cc8e25c4de95c64317" title="TREX agent timelines.">TREX_TIMELINE</a>);
<a name="l00184"></a>00184 }
<a name="l00185"></a>00185 
<a name="l00186"></a>00186 <span class="keywordtype">bool</span> Assembly::isAgentTimeline(EUROPA::DataTypeId <span class="keyword">const</span> &amp;type)<span class="keyword"> const </span>{
<a name="l00187"></a>00187   <span class="keywordflow">return</span> <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#acefaf2dd910ec5609ad7c682649507f9" title="Get europa schema.">schema</a>()-&gt;isA(type-&gt;getName(), <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#ad095f7f9e7d1a5cc8e25c4de95c64317" title="TREX agent timelines.">TREX_TIMELINE</a>);
<a name="l00188"></a>00188 }
<a name="l00189"></a>00189 
<a name="l00190"></a>00190 <span class="keywordtype">bool</span> <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#ad7f0982e42c8c434e0944e7ea7ba8178" title="Check if external.">Assembly::isExternal</a>(EUROPA::ObjectId <span class="keyword">const</span> &amp;obj)<span class="keyword"> const </span>{
<a name="l00191"></a>00191   <span class="keywordflow">return</span> isAgentTimeline(obj) 
<a name="l00192"></a>00192          &amp;&amp; m_reactor.<a class="code" href="../../df/d7a/classTREX_1_1transaction_1_1TeleoReactor.html#a41d3bf0d0663f3ff4469686dc6878d01" title="Check for exeternal timeline.">isExternal</a>(obj-&gt;getName().toString());
<a name="l00193"></a>00193 }
<a name="l00194"></a>00194 
<a name="l00195"></a>00195 <span class="keywordtype">bool</span> <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#afffd4a905c450497e2818523dd264057" title="Check if internal.">Assembly::isInternal</a>(EUROPA::ObjectId <span class="keyword">const</span> &amp;obj)<span class="keyword"> const </span>{
<a name="l00196"></a>00196   <span class="keywordflow">return</span> isAgentTimeline(obj) 
<a name="l00197"></a>00197          &amp;&amp; m_reactor.<a class="code" href="../../df/d7a/classTREX_1_1transaction_1_1TeleoReactor.html#a9d8c2a89f8940138216a1f7821adfb04" title="Check for internal timeline.">isInternal</a>(obj-&gt;getName().toString());  
<a name="l00198"></a>00198 }
<a name="l00199"></a>00199 
<a name="l00200"></a>00200 <span class="keywordtype">bool</span> <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#afffd4a905c450497e2818523dd264057" title="Check if internal.">Assembly::isInternal</a>(EUROPA::TokenId <span class="keyword">const</span> &amp;tok)<span class="keyword"> const </span>{
<a name="l00201"></a>00201   EUROPA::ObjectDomain <span class="keyword">const</span> &amp;dom = tok-&gt;getObject()-&gt;getLastDomain();
<a name="l00202"></a>00202   std::list&lt;EUROPA::ObjectId&gt; objs = dom.makeObjectList();
<a name="l00203"></a>00203 
<a name="l00204"></a>00204   <span class="keywordflow">for</span>(std::list&lt;EUROPA::ObjectId&gt;::const_iterator o=objs.begin();
<a name="l00205"></a>00205       objs.end()!=o; ++o) 
<a name="l00206"></a>00206     <span class="keywordflow">if</span>( !<a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#afffd4a905c450497e2818523dd264057" title="Check if internal.">isInternal</a>(*o) )
<a name="l00207"></a>00207       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00208"></a>00208   <span class="keywordflow">return</span> !objs.empty();
<a name="l00209"></a>00209 }
<a name="l00210"></a>00210 
<a name="l00211"></a>00211 
<a name="l00212"></a>00212 <span class="keywordtype">bool</span> <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a0b9c957c0fd4990ca285ce91657dc518" title="Check if ignored.">Assembly::isIgnored</a>(EUROPA::ObjectId <span class="keyword">const</span> &amp;obj)<span class="keyword"> const </span>{
<a name="l00213"></a>00213   <span class="keywordflow">return</span> m_ignored_objs.end()!=m_ignored_objs.find(obj);
<a name="l00214"></a>00214 }
<a name="l00215"></a>00215 
<a name="l00216"></a>00216 <span class="keywordtype">bool</span> <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a0b9c957c0fd4990ca285ce91657dc518" title="Check if ignored.">Assembly::isIgnored</a>(EUROPA::TokenId <span class="keyword">const</span> &amp;tok)<span class="keyword"> const </span>{
<a name="l00217"></a>00217   <span class="keywordflow">if</span>( m_ignored_toks.end()!=m_ignored_toks.find(tok) )
<a name="l00218"></a>00218     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00219"></a>00219   <span class="keywordflow">else</span> {
<a name="l00220"></a>00220     <span class="comment">// This token is not explicitely ignored =&gt; check if its objects are </span>
<a name="l00221"></a>00221     EUROPA::ObjectDomain <span class="keyword">const</span> &amp;domain(tok-&gt;getObject()-&gt;lastDomain());
<a name="l00222"></a>00222     std::list&lt;EUROPA::ObjectId&gt; objs=domain.makeObjectList();
<a name="l00223"></a>00223     
<a name="l00224"></a>00224     <span class="keywordflow">for</span>(std::list&lt;EUROPA::ObjectId&gt;::const_iterator i=objs.begin();
<a name="l00225"></a>00225         objs.end()!=i; ++i) 
<a name="l00226"></a>00226       <span class="keywordflow">if</span>( !<a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a0b9c957c0fd4990ca285ce91657dc518" title="Check if ignored.">isIgnored</a>(*i) )
<a name="l00227"></a>00227         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00228"></a>00228     
<a name="l00229"></a>00229     <span class="comment">// If the domain is empty it is an inconsistency and should not be ignored</span>
<a name="l00230"></a>00230     <span class="keywordflow">return</span> !objs.empty();   
<a name="l00231"></a>00231   }
<a name="l00232"></a>00232 }
<a name="l00233"></a>00233 
<a name="l00234"></a>00234 EUROPA::ConstrainedVariableId <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a06b420836c583ae74b464d9985be3435" title="Extract an object attribute.">Assembly::attribute</a>(EUROPA::ObjectId <span class="keyword">const</span> &amp;obj,
<a name="l00235"></a>00235                                                   std::string <span class="keyword">const</span> &amp;name)<span class="keyword"> const </span>{
<a name="l00236"></a>00236   <span class="comment">// Construct the full attribute name</span>
<a name="l00237"></a>00237   std::string full_name(obj-&gt;getName().toString()+<span class="stringliteral">&quot;.&quot;</span>+name);
<a name="l00238"></a>00238   <span class="comment">// Extract the corresponding variable</span>
<a name="l00239"></a>00239   EUROPA::ConstrainedVariableId var(obj-&gt;getVariable(full_name));
<a name="l00240"></a>00240   
<a name="l00241"></a>00241   <span class="keywordflow">if</span>( var.isNoId() )
<a name="l00242"></a>00242     <span class="keywordflow">throw</span> <a class="code" href="../../dd/d3e/classTREX_1_1europa_1_1EuropaException.html" title="Europa related error.">EuropaException</a>(<span class="stringliteral">&quot;Variable &quot;</span>+full_name+<span class="stringliteral">&quot; does not exists.&quot;</span>);
<a name="l00243"></a>00243   <span class="keywordflow">return</span> var;
<a name="l00244"></a>00244 }
<a name="l00245"></a>00245 
<a name="l00246"></a>00246 <span class="keywordtype">void</span> <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#ad50cc53529886baedfa60d55e1b263a9" title="Check for default predicate.">Assembly::check_default</a>(EUROPA::ObjectId <span class="keyword">const</span> &amp;obj)<span class="keyword"> const </span>{
<a name="l00247"></a>00247   EUROPA::ConstrainedVariableId default_attr = <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a47eade9aea60af20038c558d447640e2" title="Get default predicate value.">default_pred</a>(obj);
<a name="l00248"></a>00248   std::ostringstream msg;
<a name="l00249"></a>00249  
<a name="l00250"></a>00250   <span class="comment">// Check that the default is fully specified</span>
<a name="l00251"></a>00251   <span class="keywordflow">if</span>( default_attr.isNoId() || !default_attr-&gt;isSpecified() ) {
<a name="l00252"></a>00252     msg&lt;&lt;<span class="stringliteral">&quot;Internal timeline &quot;</span>&lt;&lt;obj-&gt;getName().toString()
<a name="l00253"></a>00253        &lt;&lt;<span class="stringliteral">&quot; does not specify its default predicate.&quot;</span>;
<a name="l00254"></a>00254     <span class="keywordflow">throw</span> <a class="code" href="../../dd/d3e/classTREX_1_1europa_1_1EuropaException.html" title="Europa related error.">EuropaException</a>(msg.str());
<a name="l00255"></a>00255   }
<a name="l00256"></a>00256   <span class="comment">// Check that it is an existing predicate for obj</span>
<a name="l00257"></a>00257   EUROPA::DataTypeId type = default_attr-&gt;getDataType();
<a name="l00258"></a>00258   std::string short_pred = type-&gt;toString(default_attr-&gt;getSpecifiedValue()),
<a name="l00259"></a>00259     long_pred = predicate_name(obj, short_pred);
<a name="l00260"></a>00260     
<a name="l00261"></a>00261   <span class="keywordflow">if</span>( !<a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#acefaf2dd910ec5609ad7c682649507f9" title="Get europa schema.">schema</a>()-&gt;isPredicate(long_pred) ) {
<a name="l00262"></a>00262     msg&lt;&lt;<span class="stringliteral">&quot;Internal timeline &quot;</span>&lt;&lt;obj-&gt;getName().toString()
<a name="l00263"></a>00263        &lt;&lt;<span class="stringliteral">&quot; default predicate \&quot;&quot;</span>&lt;&lt;short_pred&lt;&lt;<span class="stringliteral">&quot;\&quot; foes not exist.&quot;</span>;
<a name="l00264"></a>00264     <span class="keywordflow">throw</span> <a class="code" href="../../dd/d3e/classTREX_1_1europa_1_1EuropaException.html" title="Europa related error.">EuropaException</a>(msg.str());
<a name="l00265"></a>00265   }
<a name="l00266"></a>00266 }
<a name="l00267"></a>00267 
<a name="l00268"></a>00268 <span class="keywordtype">bool</span> <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#aabbf1a7948f457d904e341b89fabadef">Assembly::in_deliberation</a>(EUROPA::TokenId <span class="keyword">const</span> &amp;tok)<span class="keyword"> const </span>{
<a name="l00269"></a>00269   <span class="keywordflow">return</span> !<a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a0b9c957c0fd4990ca285ce91657dc518" title="Check if ignored.">isIgnored</a>(tok) &amp;&amp; active() &amp;&amp; <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a1f28e61dc187fce2ba1950e3a179acf9" title="Get the solver.">solver</a>().inDeliberation(tok);
<a name="l00270"></a>00270 }
<a name="l00271"></a>00271 
<a name="l00272"></a>00272 <span class="keywordtype">bool</span> Assembly::is_unit(EUROPA::TokenId <span class="keyword">const</span> &amp;tok, 
<a name="l00273"></a>00273                        EUROPA::TokenId &amp;merge_cand)<span class="keyword"> const </span>{
<a name="l00274"></a>00274   <span class="keywordflow">if</span>( tok-&gt;getObject()-&gt;lastDomain().isSingleton() ) {
<a name="l00275"></a>00275     std::vector&lt;EUROPA::TokenId&gt; compats;
<a name="l00276"></a>00276     <span class="keywordtype">size_t</span> choices = 0;
<a name="l00277"></a>00277     
<a name="l00278"></a>00278     <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a4b1156d1afeaaa97638ba63025b1ff02" title="Get europa plan database.">plan_db</a>()-&gt;getCompatibleTokens(tok, compats, 
<a name="l00279"></a>00279                                    std::numeric_limits&lt;unsigned int&gt;::max(), 
<a name="l00280"></a>00280                                    <span class="keyword">true</span>);
<a name="l00281"></a>00281     <span class="keywordflow">for</span>(std::vector&lt;EUROPA::TokenId&gt;::const_iterator t=compats.begin();
<a name="l00282"></a>00282         compats.end()!=t; ++t)
<a name="l00283"></a>00283       <span class="keywordflow">if</span>( !<a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#aabbf1a7948f457d904e341b89fabadef">in_deliberation</a>(*t) ) {
<a name="l00284"></a>00284         ++choices;
<a name="l00285"></a>00285         merge_cand = *t;
<a name="l00286"></a>00286       }
<a name="l00287"></a>00287     <span class="keywordflow">if</span>( 1==choices &amp;&amp; !<a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a4b1156d1afeaaa97638ba63025b1ff02" title="Get europa plan database.">plan_db</a>()-&gt;hasOrderingChoice(tok) )
<a name="l00288"></a>00288       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00289"></a>00289     <span class="keywordflow">else</span> <span class="keywordflow">if</span>( 0==choices ) {
<a name="l00290"></a>00290       merge_cand = EUROPA::TokenId::noId();
<a name="l00291"></a>00291       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00292"></a>00292     }
<a name="l00293"></a>00293   }
<a name="l00294"></a>00294   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00295"></a>00295 }
<a name="l00296"></a>00296 
<a name="l00297"></a>00297 std::pair&lt;Assembly::timeline_iterator, Assembly::timeline_iterator&gt; 
<a name="l00298"></a>00298 Assembly::find_next(EUROPA::TimelineId <span class="keyword">const</span> &amp;tl)<span class="keyword"> const </span>{
<a name="l00299"></a>00299   std::list&lt;EUROPA::TokenId&gt; <span class="keyword">const</span> &amp;seq = tl-&gt;getTokenSequence();
<a name="l00300"></a>00300   timeline_iterator i=seq.begin(), last=seq.end();
<a name="l00301"></a>00301   EUROPA::eint now = currentTick();
<a name="l00302"></a>00302   
<a name="l00303"></a>00303   <span class="keywordflow">for</span>(;last!=i &amp;&amp; (*i)-&gt;end()-&gt;lastDomain().getUpperBound()&lt;=now; ++i);
<a name="l00304"></a>00304   <span class="keywordflow">return</span> std::make_pair(i, last);
<a name="l00305"></a>00305 }
<a name="l00306"></a>00306 
<a name="l00307"></a>00307 
<a name="l00308"></a>00308 <span class="keywordtype">void</span> Assembly::log_plan(std::ostream &amp;out)<span class="keyword"> const </span>{
<a name="l00309"></a>00309   EUROPA::TokenSet <span class="keyword">const</span> &amp;all_toks = <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a4b1156d1afeaaa97638ba63025b1ff02" title="Get europa plan database.">plan_db</a>()-&gt;getTokens();
<a name="l00310"></a>00310   
<a name="l00311"></a>00311   out&lt;&lt;<span class="stringliteral">&quot;digraph plan_&quot;</span>&lt;&lt;currentTick()&lt;&lt;<span class="stringliteral">&quot; {\n&quot;</span>;
<a name="l00312"></a>00312   out&lt;&lt;<span class="stringliteral">&quot;  node[shape=\&quot;box\&quot;];\n&quot;</span>;
<a name="l00313"></a>00313   
<a name="l00314"></a>00314   <span class="keywordflow">for</span>(EUROPA::TokenSet::const_iterator t=all_toks.begin(); 
<a name="l00315"></a>00315       all_toks.end()!=t; ++t) {
<a name="l00316"></a>00316     EUROPA::TokenId active = (*t)-&gt;getActiveToken();
<a name="l00317"></a>00317     EUROPA::eint key;
<a name="l00318"></a>00318     <span class="keywordflow">if</span>( active.isNoId() ) {
<a name="l00319"></a>00319       key = (*t)-&gt;getKey();
<a name="l00320"></a>00320       
<a name="l00321"></a>00321       out&lt;&lt;<span class="stringliteral">&quot;t&quot;</span>&lt;&lt;key&lt;&lt;<span class="stringliteral">&quot;[label=\&quot;&quot;</span>&lt;&lt;(*t)-&gt;getPredicateName().toString()&lt;&lt;<span class="stringliteral">&quot;{\\n&quot;</span>;
<a name="l00322"></a>00322       std::vector&lt;EUROPA::ConstrainedVariableId&gt; <span class="keyword">const</span> &amp;attrs = (*t)-&gt;getVariables();
<a name="l00323"></a>00323       
<a name="l00324"></a>00324       <span class="keywordtype">bool</span> fact = (*t)-&gt;isFact(), 
<a name="l00325"></a>00325         goal = (*t)-&gt;getState()-&gt;baseDomain().isMember(EUROPA::Token::REJECTED);
<a name="l00326"></a>00326     
<a name="l00327"></a>00327       <span class="keywordflow">if</span>( (*t)-&gt;isActive() ) {
<a name="l00328"></a>00328         EUROPA::TokenSet <span class="keyword">const</span> &amp;merged = (*t)-&gt;getMergedTokens();
<a name="l00329"></a>00329         <span class="keywordflow">for</span>(EUROPA::TokenSet::const_iterator i=merged.begin(); merged.end()!=i; ++i) {
<a name="l00330"></a>00330           fact = fact || (*i)-&gt;isFact();
<a name="l00331"></a>00331           goal = goal || (*i)-&gt;getState()-&gt;baseDomain().isMember(EUROPA::Token::REJECTED);
<a name="l00332"></a>00332         }
<a name="l00333"></a>00333         
<a name="l00334"></a>00334       }
<a name="l00335"></a>00335       
<a name="l00336"></a>00336       <span class="keywordflow">for</span>(std::vector&lt;EUROPA::ConstrainedVariableId&gt;::const_iterator v=attrs.begin();
<a name="l00337"></a>00337           attrs.end()!=v; ++v) 
<a name="l00338"></a>00338         out&lt;&lt;(*v)-&gt;getName().toString()&lt;&lt;<span class="stringliteral">&quot;=&quot;</span>&lt;&lt;(*v)-&gt;toString()&lt;&lt;<span class="stringliteral">&quot;\\n&quot;</span>;
<a name="l00339"></a>00339       
<a name="l00340"></a>00340       <span class="keywordflow">if</span>( (*t)-&gt;isTerminated() )
<a name="l00341"></a>00341         out&lt;&lt;<span class="stringliteral">&quot;Terminated&quot;</span>;
<a name="l00342"></a>00342       <span class="keywordflow">else</span> <span class="keywordflow">if</span>( (*t)-&gt;isCommitted() )
<a name="l00343"></a>00343         out&lt;&lt;<span class="stringliteral">&quot;Committed&quot;</span>;
<a name="l00344"></a>00344       out&lt;&lt;<span class="stringliteral">&quot;}\&quot;&quot;</span>;
<a name="l00345"></a>00345       <span class="keywordflow">if</span>( <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a0b9c957c0fd4990ca285ce91657dc518" title="Check if ignored.">isIgnored</a>(*t) )
<a name="l00346"></a>00346         out&lt;&lt;<span class="stringliteral">&quot;color=grey&quot;</span>;
<a name="l00347"></a>00347       <span class="keywordflow">else</span> <span class="keywordflow">if</span>( <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#aabbf1a7948f457d904e341b89fabadef">in_deliberation</a>(*t) || goal )
<a name="l00348"></a>00348         out&lt;&lt;<span class="stringliteral">&quot;color=blue&quot;</span>;
<a name="l00349"></a>00349       <span class="keywordflow">else</span> <span class="keywordflow">if</span>( fact )
<a name="l00350"></a>00350         out&lt;&lt;<span class="stringliteral">&quot;color=red&quot;</span>;
<a name="l00351"></a>00351       out&lt;&lt;<span class="stringliteral">&quot;];\n&quot;</span>;
<a name="l00352"></a>00352     } <span class="keywordflow">else</span> 
<a name="l00353"></a>00353       key = active-&gt;getKey();
<a name="l00354"></a>00354     
<a name="l00355"></a>00355     EUROPA::TokenId master = (*t)-&gt;master();
<a name="l00356"></a>00356     
<a name="l00357"></a>00357     <span class="keywordflow">if</span>( master.isId() ) {
<a name="l00358"></a>00358       out&lt;&lt;<span class="stringliteral">&quot; t&quot;</span>&lt;&lt;master-&gt;getKey()&lt;&lt;<span class="stringliteral">&quot;-&gt;t&quot;</span>&lt;&lt;key
<a name="l00359"></a>00359       &lt;&lt;<span class="stringliteral">&quot;[label=\&quot;&quot;</span>&lt;&lt;(*t)-&gt;getRelation().toString()&lt;&lt;<span class="stringliteral">&quot;\&quot;];\n&quot;</span>;
<a name="l00360"></a>00360     }
<a name="l00361"></a>00361   }
<a name="l00362"></a>00362   
<a name="l00363"></a>00363   out&lt;&lt;<span class="stringliteral">&quot;}&quot;</span>&lt;&lt;std::endl;
<a name="l00364"></a>00364 }
<a name="l00365"></a>00365 
<a name="l00366"></a>00366 
<a name="l00367"></a>00367 <span class="comment">// manipulators </span>
<a name="l00368"></a>00368 
<a name="l00369"></a>00369 <a class="code" href="../../da/d38/classTREX_1_1utils_1_1internals_1_1LogEntry.html" title="Text Entry manager for TextLog.">TREX::utils::internals::LogEntry</a> <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a0b55b90ff316db2264004f2131f09d20" title="Log TREX message.">Assembly::log</a>(std::string <span class="keyword">const</span> &amp;context)<span class="keyword"> const </span>{
<a name="l00370"></a>00370   <span class="keywordflow">return</span> m_reactor.<a class="code" href="../../df/d7a/classTREX_1_1transaction_1_1TeleoReactor.html#abde1d28e37984ab0a0ae71a6023bcd8b" title="new log entry">syslog</a>(context);
<a name="l00371"></a>00371 }
<a name="l00372"></a>00372 
<a name="l00373"></a>00373 <span class="keywordtype">void</span> Assembly::setStream() {
<a name="l00374"></a>00374   m_trex_schema-&gt;setStream(m_debug);
<a name="l00375"></a>00375 }
<a name="l00376"></a>00376 
<a name="l00377"></a>00377 std::pair&lt;EUROPA::ObjectId, EUROPA::TokenId&gt; Assembly::convert(<a class="code" href="../../d4/db5/classTREX_1_1transaction_1_1Predicate.html" title="TREX Predicate.">Predicate</a> <span class="keyword">const</span> &amp;pred, 
<a name="l00378"></a>00378                                                                <span class="keywordtype">bool</span> isFact) {
<a name="l00379"></a>00379   EUROPA::DbClientId cli = <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a4b1156d1afeaaa97638ba63025b1ff02" title="Get europa plan database.">plan_db</a>()-&gt;getClient();
<a name="l00380"></a>00380   EUROPA::TokenId token = EUROPA::TokenId::noId();
<a name="l00381"></a>00381   <span class="keywordtype">bool</span> rejectable = !isFact;
<a name="l00382"></a>00382   
<a name="l00383"></a>00383   <span class="comment">// Get the corresponding europa object</span>
<a name="l00384"></a>00384   EUROPA::ObjectId <span class="keywordtype">object</span> = cli-&gt;getObject(pred.<a class="code" href="../../d4/db5/classTREX_1_1transaction_1_1Predicate.html#a5e18c7846b0bfe674ccf60b5cf98aa9c" title="Predicate object.">object</a>().<a class="code" href="../../dc/de0/classTREX_1_1utils_1_1BasicSymbol.html#aa1d5585755293b04022fda519ebb25c0" title="String value.">str</a>().c_str());
<a name="l00385"></a>00385   <span class="comment">// Build the predicate name for europa </span>
<a name="l00386"></a>00386   std::string pred_name=predicate_name(<span class="keywordtype">object</span>, pred.<a class="code" href="../../d4/db5/classTREX_1_1transaction_1_1Predicate.html#a028ede642074b939f4d3b2a27ca2c47a" title="predicate type">predicate</a>().<a class="code" href="../../dc/de0/classTREX_1_1utils_1_1BasicSymbol.html#aa1d5585755293b04022fda519ebb25c0" title="String value.">str</a>());
<a name="l00387"></a>00387   
<a name="l00388"></a>00388   <span class="keywordflow">if</span>( <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#acefaf2dd910ec5609ad7c682649507f9" title="Get europa schema.">schema</a>()-&gt;isPredicate(pred_name) ) {
<a name="l00389"></a>00389     token = cli-&gt;createToken(pred_name.c_str(), NULL, rejectable, isFact);
<a name="l00390"></a>00390     <span class="keywordflow">if</span>( token.isId() ) {
<a name="l00391"></a>00391       <span class="keywordflow">for</span>(Predicate::const_iterator a=pred.<a class="code" href="../../d4/db5/classTREX_1_1transaction_1_1Predicate.html#ad9f7d61308503a313ed0f525c3b26192" title="beginning of the attributes set">begin</a>(); pred.<a class="code" href="../../d4/db5/classTREX_1_1transaction_1_1Predicate.html#aa07342c1309d0fbaa5db219e83af3e43" title="end of the attributes set">end</a>()!=a; ++a) {
<a name="l00392"></a>00392         EUROPA::ConstrainedVariableId param = token-&gt;getVariable(a-&gt;first.str());
<a name="l00393"></a>00393        
<a name="l00394"></a>00394         <span class="keywordflow">if</span>( param.isId() ) {
<a name="l00395"></a>00395           <span class="keywordflow">try</span> {
<a name="l00396"></a>00396             details::europa_restrict(param, a-&gt;second.domain());
<a name="l00397"></a>00397           } <span class="keywordflow">catch</span>(<a class="code" href="../../db/d3a/classTREX_1_1transaction_1_1DomainExcept.html" title="Empty domain.">DomainExcept</a> <span class="keyword">const</span> &amp;err) {
<a name="l00398"></a>00398             <span class="comment">// I failed to apply the new domain </span>
<a name="l00399"></a>00399             <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a0b55b90ff316db2264004f2131f09d20" title="Log TREX message.">log</a>(<span class="stringliteral">&quot;WARN&quot;</span>)&lt;&lt;<span class="stringliteral">&quot;Failed to restrict attribute &quot;</span>&lt;&lt;a-&gt;first&lt;&lt;<span class="stringliteral">&quot; on token &quot;</span>
<a name="l00400"></a>00400                        &lt;&lt;pred.<a class="code" href="../../d4/db5/classTREX_1_1transaction_1_1Predicate.html#a5e18c7846b0bfe674ccf60b5cf98aa9c" title="Predicate object.">object</a>()&lt;&lt;<span class="charliteral">&#39;.&#39;</span>&lt;&lt;pred.<a class="code" href="../../d4/db5/classTREX_1_1transaction_1_1Predicate.html#a028ede642074b939f4d3b2a27ca2c47a" title="predicate type">predicate</a>()&lt;&lt;<span class="stringliteral">&quot;: &quot;</span>&lt;&lt;err;
<a name="l00401"></a>00401           }
<a name="l00402"></a>00402         } <span class="keywordflow">else</span> {
<a name="l00403"></a>00403           <span class="comment">// Unknown attribute </span>
<a name="l00404"></a>00404           <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a0b55b90ff316db2264004f2131f09d20" title="Log TREX message.">log</a>(<span class="stringliteral">&quot;WARN&quot;</span>)&lt;&lt;<span class="stringliteral">&quot;Unknown attribute &quot;</span>&lt;&lt;a-&gt;first&lt;&lt;<span class="stringliteral">&quot; on token &quot;</span>
<a name="l00405"></a>00405                      &lt;&lt;pred.<a class="code" href="../../d4/db5/classTREX_1_1transaction_1_1Predicate.html#a5e18c7846b0bfe674ccf60b5cf98aa9c" title="Predicate object.">object</a>()&lt;&lt;<span class="charliteral">&#39;.&#39;</span>&lt;&lt;pred.<a class="code" href="../../d4/db5/classTREX_1_1transaction_1_1Predicate.html#a028ede642074b939f4d3b2a27ca2c47a" title="predicate type">predicate</a>();
<a name="l00406"></a>00406         }
<a name="l00407"></a>00407       }
<a name="l00408"></a>00408     } <span class="keywordflow">else</span> 
<a name="l00409"></a>00409       <span class="keywordflow">throw</span> <a class="code" href="../../dd/d3e/classTREX_1_1europa_1_1EuropaException.html" title="Europa related error.">EuropaException</a>(<span class="stringliteral">&quot;Failed to create new token &quot;</span>+pred_name+<span class="stringliteral">&quot;: unknown europa error&quot;</span>);
<a name="l00410"></a>00410   } <span class="keywordflow">else</span> {
<a name="l00411"></a>00411     <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a0b55b90ff316db2264004f2131f09d20" title="Log TREX message.">log</a>(<span class="stringliteral">&quot;WARN&quot;</span>)&lt;&lt;<span class="stringliteral">&quot;Unknown predicate \&quot;&quot;</span>&lt;&lt;pred.<a class="code" href="../../d4/db5/classTREX_1_1transaction_1_1Predicate.html#a028ede642074b939f4d3b2a27ca2c47a" title="predicate type">predicate</a>()&lt;&lt;<span class="stringliteral">&quot;\&quot; for object &quot;</span>
<a name="l00412"></a>00412                &lt;&lt;pred.<a class="code" href="../../d4/db5/classTREX_1_1transaction_1_1Predicate.html#a028ede642074b939f4d3b2a27ca2c47a" title="predicate type">predicate</a>();
<a name="l00413"></a>00413     <span class="keywordflow">if</span>( isFact ) {
<a name="l00414"></a>00414       pred_name = predicate_name(<span class="keywordtype">object</span>, <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a65d498ecdb1911fcf764c336c5dceae2" title="undefined predicate name">UNDEFINED_PRED</a>);
<a name="l00415"></a>00415       <span class="keywordflow">if</span>( <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#acefaf2dd910ec5609ad7c682649507f9" title="Get europa schema.">schema</a>()-&gt;isPredicate(pred_name) ) {
<a name="l00416"></a>00416         token = cli-&gt;createToken(pred_name.c_str(), NULL, rejectable, isFact);
<a name="l00417"></a>00417         <span class="keywordflow">if</span>( token.isNoId() )
<a name="l00418"></a>00418           <span class="keywordflow">throw</span> <a class="code" href="../../dd/d3e/classTREX_1_1europa_1_1EuropaException.html" title="Europa related error.">EuropaException</a>(<span class="stringliteral">&quot;Failed to create new token &quot;</span>+pred_name+<span class="stringliteral">&quot;: unknown europa error&quot;</span>);
<a name="l00419"></a>00419       } <span class="keywordflow">else</span> 
<a name="l00420"></a>00420         <span class="keywordflow">throw</span> <a class="code" href="../../dd/d3e/classTREX_1_1europa_1_1EuropaException.html" title="Europa related error.">EuropaException</a>(<span class="stringliteral">&quot;Unable to create special \&quot;&quot;</span>+<a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a65d498ecdb1911fcf764c336c5dceae2" title="undefined predicate name">UNDEFINED_PRED</a>+
<a name="l00421"></a>00421                               <span class="stringliteral">&quot;\&quot; predicate for the object &quot;</span>+object-&gt;getName().toString());
<a name="l00422"></a>00422     } 
<a name="l00423"></a>00423   }
<a name="l00424"></a>00424   
<a name="l00425"></a>00425   <span class="keywordflow">if</span>( token.isId() ) {
<a name="l00426"></a>00426     <span class="comment">// Specify the object </span>
<a name="l00427"></a>00427     EUROPA::ConstrainedVariableId tok_obj = token-&gt;getObject();
<a name="l00428"></a>00428     tok_obj-&gt;specify(object-&gt;getKey());
<a name="l00429"></a>00429   }
<a name="l00430"></a>00430   <span class="keywordflow">return</span> std::make_pair(<span class="keywordtype">object</span>, token);
<a name="l00431"></a>00431 }
<a name="l00432"></a>00432 
<a name="l00433"></a>00433 <span class="keywordtype">void</span> Assembly::update_clock(EUROPA::IntervalIntDomain <span class="keyword">const</span> &amp;dom, 
<a name="l00434"></a>00434                             <span class="keywordtype">bool</span> init) {
<a name="l00435"></a>00435   <span class="keywordflow">if</span>( init &amp;&amp; m_clock.isNoId() ) {
<a name="l00436"></a>00436     m_clock = <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a4b1156d1afeaaa97638ba63025b1ff02" title="Get europa plan database.">plan_db</a>()-&gt;getGlobalVariable(CLOCK_VAR);
<a name="l00437"></a>00437     <span class="keywordflow">if</span>( m_clock.isNoId() ) {
<a name="l00438"></a>00438       debugMsg(<span class="stringliteral">&quot;trex:always&quot;</span>, <span class="stringliteral">&quot;Unable to find clock variable \&quot;&quot;</span>&lt;&lt;CLOCK_VAR.toString()&lt;&lt;<span class="charliteral">&#39;\&quot;&#39;</span>);
<a name="l00439"></a>00439       <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a0b55b90ff316db2264004f2131f09d20" title="Log TREX message.">log</a>(<span class="stringliteral">&quot;WARN&quot;</span>)&lt;&lt;<span class="stringliteral">&quot;Unable to locate the clock variabe \&quot;&quot;</span>&lt;&lt;CLOCK_VAR.toString()&lt;&lt;<span class="stringliteral">&quot;\&quot; in the model.&quot;</span>;
<a name="l00440"></a>00440     }
<a name="l00441"></a>00441   }
<a name="l00442"></a>00442   <span class="keywordflow">if</span>( m_clock.isId() )
<a name="l00443"></a>00443     m_clock-&gt;restrictBaseDomain(dom);
<a name="l00444"></a>00444 }
<a name="l00445"></a>00445 
<a name="l00446"></a>00446 <span class="keywordtype">void</span> <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#ac60bbbf3170e277bcaf0690589f56002" title="Set final tick.">Assembly::setFinalTick</a>(<a class="code" href="../../db/db4/group__transaction.html#ga71ccb7c46d43d3d538c401886b341ada" title="TREX unit of time.">TICK</a> value) {
<a name="l00447"></a>00447   EUROPA::ConstrainedVariableId mission_end = <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a4b1156d1afeaaa97638ba63025b1ff02" title="Get europa plan database.">plan_db</a>()-&gt;getGlobalVariable(<a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#ab4ddfc1746112972d3e1502c1c33a7b1" title="Europa mission end variable.">MISSION_END</a>);
<a name="l00448"></a>00448   
<a name="l00449"></a>00449   <span class="keywordflow">if</span>( mission_end.isNoId() )
<a name="l00450"></a>00450     <span class="keywordflow">throw</span> <a class="code" href="../../d6/d6d/classTREX_1_1transaction_1_1ReactorException.html" title="TeleoReactor related exception.">ReactorException</a>(m_reactor, <span class="stringliteral">&quot;Unable to locate variable &quot;</span>+<a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#ab4ddfc1746112972d3e1502c1c33a7b1" title="Europa mission end variable.">MISSION_END</a>.toString()
<a name="l00451"></a>00451                            +<span class="stringliteral">&quot; in the model&quot;</span>);
<a name="l00452"></a>00452   mission_end-&gt;restrictBaseDomain(EUROPA::IntervalIntDomain(value));
<a name="l00453"></a>00453   
<a name="l00454"></a>00454   update_clock(EUROPA::IntervalIntDomain(std::numeric_limits&lt;EUROPA::eint&gt;::minus_infinity(),
<a name="l00455"></a>00455                                          EUROPA::eint(value)), <span class="keyword">true</span>);
<a name="l00456"></a>00456 }
<a name="l00457"></a>00457 
<a name="l00458"></a>00458 <span class="keywordtype">void</span> <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a05015598a38e2d3c9b2f7e338f907e93" title="Update clock.">Assembly::clock_advance</a>(<a class="code" href="../../db/db4/group__transaction.html#ga71ccb7c46d43d3d538c401886b341ada" title="TREX unit of time.">TREX::transaction::TICK</a> value) {
<a name="l00459"></a>00459   update_clock(EUROPA::IntervalIntDomain(EUROPA::eint(value),
<a name="l00460"></a>00460                                          std::numeric_limits&lt;EUROPA::eint&gt;::infinity()));
<a name="l00461"></a>00461 }
<a name="l00462"></a>00462 
<a name="l00463"></a>00463 
<a name="l00464"></a>00464 <span class="keywordtype">void</span> <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a4114f61586ade4269babbfc9cb86a3dc" title="Set tick duration.">Assembly::setTickFactor</a>(<span class="keywordtype">double</span> delta) {
<a name="l00465"></a>00465   EUROPA::ConstrainedVariableId tick = <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a4b1156d1afeaaa97638ba63025b1ff02" title="Get europa plan database.">plan_db</a>()-&gt;getGlobalVariable(<a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a53b1f48299aef37e84148306cd38bba6" title="tick duration variable">TICK_DURATION</a>);
<a name="l00466"></a>00466   
<a name="l00467"></a>00467   <span class="keywordflow">if</span>( tick.isNoId() ) 
<a name="l00468"></a>00468     <span class="keywordflow">throw</span> <a class="code" href="../../d6/d6d/classTREX_1_1transaction_1_1ReactorException.html" title="TeleoReactor related exception.">ReactorException</a>(m_reactor, <span class="stringliteral">&quot;Unable to locate variable &quot;</span>+
<a name="l00469"></a>00469                            <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a53b1f48299aef37e84148306cd38bba6" title="tick duration variable">TICK_DURATION</a>.toString()+<span class="stringliteral">&quot; in the model.&quot;</span>);
<a name="l00470"></a>00470   <span class="keywordflow">else</span> 
<a name="l00471"></a>00471     tick-&gt;restrictBaseDomain(EUROPA::IntervalDomain(delta));
<a name="l00472"></a>00472 }
<a name="l00473"></a>00473 
<a name="l00474"></a>00474 <span class="keywordtype">bool</span> <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a032b448b67f81e5f1ddc21ea5fac9ba9" title="Load a model.">Assembly::playTransaction</a>(std::string <span class="keyword">const</span> &amp;nddl) {
<a name="l00475"></a>00475   <span class="keywordtype">bool</span> found;
<a name="l00476"></a>00476   std::string config_file;
<a name="l00477"></a>00477   
<a name="l00478"></a>00478   <span class="comment">// Parse the configuration file </span>
<a name="l00479"></a>00479   config_file = m_reactor.<a class="code" href="../../df/d7a/classTREX_1_1transaction_1_1TeleoReactor.html#a975231dd2846e0a806833f93d79dabb5" title="LogManager acces point.">manager</a>().<a class="code" href="../../d2/d8b/classTREX_1_1utils_1_1LogManager.html#abd315b6112cd5975b4af4cf710afb629" title="Configuration files management.">use</a>(<span class="stringliteral">&quot;NDDL.cfg&quot;</span>, found);
<a name="l00480"></a>00480   <span class="keywordflow">if</span>( !found ) {
<a name="l00481"></a>00481     config_file = m_reactor.<a class="code" href="../../df/d7a/classTREX_1_1transaction_1_1TeleoReactor.html#a975231dd2846e0a806833f93d79dabb5" title="LogManager acces point.">manager</a>().<a class="code" href="../../d2/d8b/classTREX_1_1utils_1_1LogManager.html#abd315b6112cd5975b4af4cf710afb629" title="Configuration files management.">use</a>(<span class="stringliteral">&quot;temp_nddl_gen.cfg&quot;</span>, found);
<a name="l00482"></a>00482     <span class="keywordflow">if</span>( !found ) 
<a name="l00483"></a>00483       <span class="keywordflow">throw</span> <a class="code" href="../../d6/d6d/classTREX_1_1transaction_1_1ReactorException.html" title="TeleoReactor related exception.">ReactorException</a>(m_reactor, 
<a name="l00484"></a>00484                              <span class="stringliteral">&quot;Unable to locate NDDL.cfg or temp_nddl_gen.cfg&quot;</span>);
<a name="l00485"></a>00485   }
<a name="l00486"></a>00486   boost::property_tree::ptree cfg;
<a name="l00487"></a>00487   read_xml(config_file, cfg, xml::no_comments|xml::trim_whitespace);
<a name="l00488"></a>00488   
<a name="l00489"></a>00489   <span class="keywordflow">if</span>( cfg.empty() )
<a name="l00490"></a>00490     <span class="keywordflow">throw</span> <a class="code" href="../../d6/d6d/classTREX_1_1transaction_1_1ReactorException.html" title="TeleoReactor related exception.">ReactorException</a>(m_reactor, 
<a name="l00491"></a>00491                            config_file+<span class="stringliteral">&quot; europa configuration appears to be empty.&quot;</span>);
<a name="l00492"></a>00492   <span class="keywordflow">else</span> <span class="keywordflow">if</span>( cfg.size()!=1 )
<a name="l00493"></a>00493     <span class="keywordflow">throw</span> <a class="code" href="../../d6/d6d/classTREX_1_1transaction_1_1ReactorException.html" title="TeleoReactor related exception.">ReactorException</a>(m_reactor, 
<a name="l00494"></a>00494                            config_file+<span class="stringliteral">&quot; europa configuration have multiple XML roots.&quot;</span>);
<a name="l00495"></a>00495   
<a name="l00496"></a>00496   <span class="comment">// extract the &lt;include/&gt; tags from the configuration</span>
<a name="l00497"></a>00497   boost::property_tree::ptree::const_assoc_iterator i, last;
<a name="l00498"></a>00498   boost::tie(i, last) = cfg.front().second.equal_range(<span class="stringliteral">&quot;include&quot;</span>);
<a name="l00499"></a>00499   
<a name="l00500"></a>00500   <span class="keywordflow">for</span>(; last!=i; ++i) {
<a name="l00501"></a>00501     std::string path = parse_attr&lt;std::string&gt;(*i, <span class="stringliteral">&quot;path&quot;</span>);
<a name="l00502"></a>00502     boost::replace_all(path, <span class="stringliteral">&quot;;&quot;</span>, <span class="stringliteral">&quot;:&quot;</span>);
<a name="l00503"></a>00503     getLanguageInterpreter(<span class="stringliteral">&quot;nddl&quot;</span>)-&gt;getEngine()-&gt;getConfig()-&gt;setProperty(<span class="stringliteral">&quot;nddl.includePath&quot;</span>, path);
<a name="l00504"></a>00504   }
<a name="l00505"></a>00505   
<a name="l00506"></a>00506   <span class="comment">// Add TREX_PATH to the includePath</span>
<a name="l00507"></a>00507   std::ostringstream trex_path;
<a name="l00508"></a>00508   
<a name="l00509"></a>00509   trex_path&lt;&lt;<span class="charliteral">&#39;.&#39;</span>;
<a name="l00510"></a>00510   <span class="keywordflow">for</span>(<a class="code" href="../../d2/d8b/classTREX_1_1utils_1_1LogManager.html#ac9e33406d5d59fa8be27922e9d0d2e9e" title="TREX_PATH iterator.">LogManager::path_iterator</a> p=m_reactor.<a class="code" href="../../df/d7a/classTREX_1_1transaction_1_1TeleoReactor.html#a975231dd2846e0a806833f93d79dabb5" title="LogManager acces point.">manager</a>().<a class="code" href="../../d2/d8b/classTREX_1_1utils_1_1LogManager.html#a67dd30f0e14b79d9f60643cb4c275de4" title="First path.">begin</a>();
<a name="l00511"></a>00511       m_reactor.<a class="code" href="../../df/d7a/classTREX_1_1transaction_1_1TeleoReactor.html#a975231dd2846e0a806833f93d79dabb5" title="LogManager acces point.">manager</a>().<a class="code" href="../../d2/d8b/classTREX_1_1utils_1_1LogManager.html#a1bd090554dbe669e46c81b85676da896" title="End of searh path.">end</a>()!=p; ++p) 
<a name="l00512"></a>00512     trex_path&lt;&lt;<span class="charliteral">&#39;:&#39;</span>&lt;&lt;*p;
<a name="l00513"></a>00513   getLanguageInterpreter(<span class="stringliteral">&quot;nddl&quot;</span>)-&gt;getEngine()-&gt;getConfig()-&gt;setProperty(<span class="stringliteral">&quot;nddl.includePath&quot;</span>, trex_path.str());
<a name="l00514"></a>00514   
<a name="l00515"></a>00515   <span class="comment">// Finally load the nddl model</span>
<a name="l00516"></a>00516   std::string ret;
<a name="l00517"></a>00517   
<a name="l00518"></a>00518   <span class="keywordflow">try</span> {
<a name="l00519"></a>00519     ret = executeScript(<span class="stringliteral">&quot;nddl&quot;</span>, nddl, <span class="keyword">true</span>);
<a name="l00520"></a>00520   } <span class="keywordflow">catch</span>(EUROPA::PSLanguageExceptionList <span class="keyword">const</span> &amp;le) {
<a name="l00521"></a>00521     std::ostringstream msg;
<a name="l00522"></a>00522     msg&lt;&lt;<span class="stringliteral">&quot;Error while parsing &quot;</span>&lt;&lt;nddl&lt;&lt;<span class="stringliteral">&quot;:\n&quot;</span>&lt;&lt;le;
<a name="l00523"></a>00523     <span class="keywordflow">throw</span> <a class="code" href="../../d6/d6d/classTREX_1_1transaction_1_1ReactorException.html" title="TeleoReactor related exception.">ReactorException</a>(m_reactor, msg.str());
<a name="l00524"></a>00524   } <span class="keywordflow">catch</span>(Error <span class="keyword">const</span> &amp;ee) {
<a name="l00525"></a>00525     std::ostringstream msg;
<a name="l00526"></a>00526     msg&lt;&lt;<span class="stringliteral">&quot;Error while parsing &quot;</span>&lt;&lt;nddl&lt;&lt;<span class="stringliteral">&quot;:\n&quot;</span>&lt;&lt;ee.getMsg();
<a name="l00527"></a>00527     <span class="keywordflow">throw</span> <a class="code" href="../../d6/d6d/classTREX_1_1transaction_1_1ReactorException.html" title="TeleoReactor related exception.">ReactorException</a>(m_reactor, msg.str());    
<a name="l00528"></a>00528   }
<a name="l00529"></a>00529   <span class="keywordflow">if</span>( !ret.empty() ) 
<a name="l00530"></a>00530     <span class="keywordflow">throw</span> <a class="code" href="../../d6/d6d/classTREX_1_1transaction_1_1ReactorException.html" title="TeleoReactor related exception.">ReactorException</a>(m_reactor, <span class="stringliteral">&quot;Error while parsing &quot;</span>+nddl+<span class="stringliteral">&quot;:\n&quot;</span>+ret);
<a name="l00531"></a>00531 
<a name="l00532"></a>00532   <span class="comment">// Indicate if the model is consistent</span>
<a name="l00533"></a>00533   <span class="keywordflow">return</span> m_cstr_engine-&gt;constraintConsistent();
<a name="l00534"></a>00534 }
<a name="l00535"></a>00535 
<a name="l00536"></a>00536 <span class="keywordtype">void</span> <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#ac7a07eda65e94bcdbf3926d8eba20d00" title="That plan solver configuration.">Assembly::configure_solver</a>(std::string <span class="keyword">const</span> &amp;cfg) {
<a name="l00537"></a>00537   <span class="keywordflow">if</span>( NULL==m_solver.get() ) {
<a name="l00538"></a>00538     <span class="keywordtype">bool</span> found;
<a name="l00539"></a>00539     std::string solver_file = m_reactor.<a class="code" href="../../df/d7a/classTREX_1_1transaction_1_1TeleoReactor.html#a975231dd2846e0a806833f93d79dabb5" title="LogManager acces point.">manager</a>().<a class="code" href="../../d2/d8b/classTREX_1_1utils_1_1LogManager.html#abd315b6112cd5975b4af4cf710afb629" title="Configuration files management.">use</a>(cfg, found);
<a name="l00540"></a>00540     
<a name="l00541"></a>00541     <span class="keywordflow">if</span>( !found ) 
<a name="l00542"></a>00542       <span class="keywordflow">throw</span> <a class="code" href="../../d6/d6d/classTREX_1_1transaction_1_1ReactorException.html" title="TeleoReactor related exception.">ReactorException</a>(m_reactor, 
<a name="l00543"></a>00543                              <span class="stringliteral">&quot;Unable to locate solver config \&quot;&quot;</span>+cfg+<span class="stringliteral">&quot;\&quot;&quot;</span>);
<a name="l00544"></a>00544     
<a name="l00545"></a>00545     <span class="comment">// Extract xml using TinyXml for Europa </span>
<a name="l00546"></a>00546     std::auto_ptr&lt;EUROPA::TiXmlElement&gt; xml_cfg(EUROPA::initXml(solver_file.c_str()));
<a name="l00547"></a>00547     
<a name="l00548"></a>00548     <span class="keywordflow">if</span>( NULL==xml_cfg.get() )
<a name="l00549"></a>00549       <span class="keywordflow">throw</span> <a class="code" href="../../d6/d6d/classTREX_1_1transaction_1_1ReactorException.html" title="TeleoReactor related exception.">ReactorException</a>(m_reactor,
<a name="l00550"></a>00550                              <span class="stringliteral">&quot;Failed to parse XML from &quot;</span>+cfg);
<a name="l00551"></a>00551     <span class="comment">// Inject the DeliberationFilter </span>
<a name="l00552"></a>00552     EUROPA::TiXmlElement filter(<span class="stringliteral">&quot;FlawFilter&quot;</span>);
<a name="l00553"></a>00553     filter.SetAttribute(<span class="stringliteral">&quot;component&quot;</span>, <span class="stringliteral">&quot;DeliberationFilter&quot;</span>);
<a name="l00554"></a>00554     xml_cfg-&gt;InsertBeforeChild(xml_cfg-&gt;FirstChild(), filter);
<a name="l00555"></a>00555     
<a name="l00556"></a>00556     DeliberationFilter::set_current(<span class="keyword">this</span>);
<a name="l00557"></a>00557     
<a name="l00558"></a>00558     m_solver.reset(<span class="keyword">new</span> <a class="code" href="../../de/d89/classTREX_1_1europa_1_1DbSolver.html">DbSolver</a>(*<span class="keyword">this</span>, *xml_cfg));
<a name="l00559"></a>00559   } <span class="keywordflow">else</span> 
<a name="l00560"></a>00560     <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a0b55b90ff316db2264004f2131f09d20" title="Log TREX message.">log</a>(<span class="stringliteral">&quot;WARN&quot;</span>)&lt;&lt;<span class="stringliteral">&quot;Attempted to configure the solver more than once.&quot;</span>;
<a name="l00561"></a>00561 }
<a name="l00562"></a>00562 
<a name="l00563"></a>00563 <span class="keywordtype">bool</span> Assembly::merge_token(EUROPA::TokenId <span class="keyword">const</span> &amp;tok,
<a name="l00564"></a>00564                            EUROPA::TokenId <span class="keyword">const</span> &amp;cand) {
<a name="l00565"></a>00565   <span class="keywordflow">if</span>( invalid() || cand.isNoId() )
<a name="l00566"></a>00566     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00567"></a>00567   <span class="keywordflow">if</span>( !( tok-&gt;isInactive()
<a name="l00568"></a>00568         &amp;&amp; tok-&gt;getState()-&gt;getLastDomain().isMember(EUROPA::Token::MERGED) ) )
<a name="l00569"></a>00569     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00570"></a>00570   tok-&gt;merge(cand);
<a name="l00571"></a>00571   <span class="comment">//return propagate();</span>
<a name="l00572"></a>00572   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00573"></a>00573 }
<a name="l00574"></a>00574 
<a name="l00575"></a>00575 <span class="keywordtype">bool</span> Assembly::insert_token(EUROPA::TokenId <span class="keyword">const</span> &amp;tok,
<a name="l00576"></a>00576                             <span class="keywordtype">size_t</span> &amp;steps) {
<a name="l00577"></a>00577   <span class="keywordflow">if</span>( invalid() || <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#aabbf1a7948f457d904e341b89fabadef">in_deliberation</a>(tok) )
<a name="l00578"></a>00578     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00579"></a>00579   <span class="keywordflow">if</span>( tok-&gt;isInactive() )
<a name="l00580"></a>00580     tok-&gt;activate();
<a name="l00581"></a>00581   EUROPA::ObjectDomain <span class="keyword">const</span> &amp;objs=tok-&gt;getObject()-&gt;lastDomain();
<a name="l00582"></a>00582   <span class="keywordflow">if</span>( !objs.isSingleton() )
<a name="l00583"></a>00583     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00584"></a>00584   EUROPA::ObjectId obj = objs.getObject(objs.getSingletonValue());
<a name="l00585"></a>00585   
<a name="l00586"></a>00586   <span class="keywordflow">if</span>( EUROPA::TimelineId::convertable(obj) ) {
<a name="l00587"></a>00587     std::vector&lt;EUROPA::OrderingChoice&gt; choices;
<a name="l00588"></a>00588 
<a name="l00589"></a>00589     <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a4b1156d1afeaaa97638ba63025b1ff02" title="Get europa plan database.">plan_db</a>()-&gt;getOrderingChoices(tok, choices, 1);
<a name="l00590"></a>00590     <span class="keywordflow">if</span>( choices.empty() )
<a name="l00591"></a>00591       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00592"></a>00592     EUROPA::TokenId pred, succ;
<a name="l00593"></a>00593     boost::tie(pred,succ) = choices[0].second;
<a name="l00594"></a>00594     choices[0].first-&gt;constrain(pred, succ);
<a name="l00595"></a>00595   }
<a name="l00596"></a>00596   <span class="comment">// return propagate()</span>
<a name="l00597"></a>00597   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00598"></a>00598 }
<a name="l00599"></a>00599 
<a name="l00600"></a>00600 <span class="keywordtype">bool</span> Assembly::insert_default(EUROPA::TimelineId <span class="keyword">const</span> &amp;obj,
<a name="l00601"></a>00601                               EUROPA::TokenId &amp;tok,
<a name="l00602"></a>00602                               <span class="keywordtype">size_t</span> &amp;steps) {
<a name="l00603"></a>00603   EUROPA::eint cur = currentTick();
<a name="l00604"></a>00604   EUROPA::IntervalIntDomain now(cur);
<a name="l00605"></a>00605   EUROPA::ConstrainedVariableId pred_var = <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a47eade9aea60af20038c558d447640e2" title="Get default predicate value.">default_pred</a>(obj);
<a name="l00606"></a>00606   EUROPA::DataTypeId type = pred_var-&gt;getDataType();
<a name="l00607"></a>00607   std::string pred_name = predicate_name(obj, 
<a name="l00608"></a>00608                                          type-&gt;toString(pred_var-&gt;getSpecifiedValue()));
<a name="l00609"></a>00609   tok = <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a4b1156d1afeaaa97638ba63025b1ff02" title="Get europa plan database.">plan_db</a>()-&gt;getClient()-&gt;createToken(pred_name.c_str(), NULL, <span class="keyword">false</span>);
<a name="l00610"></a>00610   tok-&gt;start()-&gt;restrictBaseDomain(now);
<a name="l00611"></a>00611   tok-&gt;activate();
<a name="l00612"></a>00612   tok-&gt;getObject()-&gt;specify(obj-&gt;getKey());
<a name="l00613"></a>00613   <span class="keywordflow">return</span> insert_token(tok, steps);
<a name="l00614"></a>00614 }
<a name="l00615"></a>00615 
<a name="l00616"></a>00616 
<a name="l00617"></a>00617 
<a name="l00618"></a>00618 <span class="comment">// modifiers </span>
<a name="l00619"></a>00619 
<a name="l00620"></a>00620 
<a name="l00621"></a>00621 <span class="keywordtype">void</span> Assembly::mark_invalid() {
<a name="l00622"></a>00622   <span class="keywordflow">if</span>( !invalid() ) {
<a name="l00623"></a>00623     debugMsg(<span class="stringliteral">&quot;trex:assembly&quot;</span>, <span class="stringliteral">&quot;Marked as INVALID&quot;</span>);
<a name="l00624"></a>00624     m_state = INVALID;
<a name="l00625"></a>00625   }
<a name="l00626"></a>00626 }
<a name="l00627"></a>00627 
<a name="l00628"></a>00628 <span class="keywordtype">void</span> <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a6d82ffc764606b37fce35a1d77fa9f18" title="Set as ignored object.">Assembly::ignore</a>(EUROPA::ObjectId <span class="keyword">const</span> &amp;obj) {
<a name="l00629"></a>00629   debugMsg(<span class="stringliteral">&quot;trex:assembly&quot;</span>, <span class="stringliteral">&quot;Ignoring object &quot;</span>+obj-&gt;toString()); 
<a name="l00630"></a>00630   m_ignored_objs.insert(obj);
<a name="l00631"></a>00631 }
<a name="l00632"></a>00632 
<a name="l00633"></a>00633 <span class="keywordtype">void</span> <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a6d82ffc764606b37fce35a1d77fa9f18" title="Set as ignored object.">Assembly::ignore</a>(EUROPA::TokenId <span class="keyword">const</span> &amp;tok) {
<a name="l00634"></a>00634   <span class="keywordflow">if</span>( !<a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a0b9c957c0fd4990ca285ce91657dc518" title="Check if ignored.">isIgnored</a>(tok) ) {
<a name="l00635"></a>00635     debugMsg(<span class="stringliteral">&quot;trex:assembly&quot;</span>, <span class="stringliteral">&quot;Ignoring token &quot;</span>+tok-&gt;toString()); 
<a name="l00636"></a>00636     m_ignored_toks.insert(tok);
<a name="l00637"></a>00637   }
<a name="l00638"></a>00638 }
<a name="l00639"></a>00639 
<a name="l00640"></a>00640 <span class="keywordtype">bool</span> Assembly::set_filter(<a class="code" href="../../d6/dc0/classTREX_1_1europa_1_1DeliberationFilter.html">DeliberationFilter</a> *filt) {
<a name="l00641"></a>00641   <span class="keywordflow">if</span>( NULL!=m_filter ) {
<a name="l00642"></a>00642     m_filter = filt;
<a name="l00643"></a>00643     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00644"></a>00644   } <span class="keywordflow">else</span> {
<a name="l00645"></a>00645     <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a0b55b90ff316db2264004f2131f09d20" title="Log TREX message.">log</a>(<span class="stringliteral">&quot;WARN&quot;</span>)&lt;&lt;<span class="stringliteral">&quot;Multiple deliberation filters.&quot;</span>;
<a name="l00646"></a>00646     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00647"></a>00647   }
<a name="l00648"></a>00648 }
<a name="l00649"></a>00649 
<a name="l00650"></a>00650 
<a name="l00651"></a>00651 <span class="keywordtype">void</span> Assembly::add_goal(EUROPA::TokenId <span class="keyword">const</span> &amp;tok, 
<a name="l00652"></a>00652                         <a class="code" href="../../db/db4/group__transaction.html#ga12f8cf7d56f88a24ecf3be17dca87d45" title="A goal identifier.">TREX::transaction::goal_id</a> <span class="keyword">const</span> &amp;req) {
<a name="l00653"></a>00653   m_goals[tok] = req;
<a name="l00654"></a>00654 }
<a name="l00655"></a>00655 
<a name="l00656"></a>00656 <span class="keywordtype">void</span> Assembly::recall(<a class="code" href="../../db/db4/group__transaction.html#ga12f8cf7d56f88a24ecf3be17dca87d45" title="A goal identifier.">TREX::transaction::goal_id</a> <span class="keyword">const</span> &amp;req) {
<a name="l00657"></a>00657   goal_map::iterator i = m_goals.begin();
<a name="l00658"></a>00658   <span class="keywordflow">for</span>(; m_goals.end()!=i; ++i) {
<a name="l00659"></a>00659     <span class="keywordflow">if</span>( req==i-&gt;second )
<a name="l00660"></a>00660       m_recalled.insert(i-&gt;first);
<a name="l00661"></a>00661   }
<a name="l00662"></a>00662 }
<a name="l00663"></a>00663 
<a name="l00664"></a>00664 <span class="keywordtype">bool</span> Assembly::remove_goal(EUROPA::TokenId <span class="keyword">const</span> &amp;goal) {
<a name="l00665"></a>00665   goal_map::iterator i=m_goals.find(goal);
<a name="l00666"></a>00666   
<a name="l00667"></a>00667   <span class="keywordflow">if</span>( m_goals.end()!=i ) {
<a name="l00668"></a>00668     <span class="comment">// I may want to notify the reactor of this internal goal completion (?)</span>
<a name="l00669"></a>00669     <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a0b55b90ff316db2264004f2131f09d20" title="Log TREX message.">log</a>(<span class="stringliteral">&quot;INFO&quot;</span>)&lt;&lt;i-&gt;second-&gt;object()&lt;&lt;<span class="charliteral">&#39;.&#39;</span>&lt;&lt;i-&gt;second-&gt;predicate()
<a name="l00670"></a>00670                &lt;&lt;<span class="charliteral">&#39;(&#39;</span>&lt;&lt;i-&gt;second&lt;&lt;<span class="stringliteral">&quot;) completed.&quot;</span>;
<a name="l00671"></a>00671     m_goals.erase(i);
<a name="l00672"></a>00672     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00673"></a>00673   } <span class="keywordflow">else</span> 
<a name="l00674"></a>00674     <span class="keywordflow">return</span> 0!=m_recalled.erase(goal);
<a name="l00675"></a>00675 }
<a name="l00676"></a>00676 
<a name="l00677"></a>00677 <span class="keywordtype">bool</span> Assembly::relax(<span class="keywordtype">bool</span> aggressive) {
<a name="l00678"></a>00678   <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a1f28e61dc187fce2ba1950e3a179acf9" title="Get the solver.">solver</a>().reset(); <span class="comment">// backtrack former plan decisions (if any)</span>
<a name="l00679"></a>00679   m_state = INACTIVE;
<a name="l00680"></a>00680   EUROPA::TokenSet tokens = <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a4b1156d1afeaaa97638ba63025b1ff02" title="Get europa plan database.">plan_db</a>()-&gt;getGlobalTokens();
<a name="l00681"></a>00681   
<a name="l00682"></a>00682   <span class="keywordflow">for</span>(EUROPA::TokenSet::const_iterator t=tokens.begin();
<a name="l00683"></a>00683       tokens.end()!=t; ++t) {
<a name="l00684"></a>00684     <span class="keywordflow">if</span>( (*t)-&gt;isClosed() &amp;&amp; !(*t)-&gt;isInactive() )
<a name="l00685"></a>00685       (*t)-&gt;cancel();
<a name="l00686"></a>00686     <span class="keywordflow">if</span>( aggressive &amp;&amp; (*t)-&gt;end()-&gt;baseDomain().getUpperBound()&lt;currentTick() )
<a name="l00687"></a>00687       (*t)-&gt;discard();
<a name="l00688"></a>00688   }
<a name="l00689"></a>00689   <span class="keywordflow">return</span> propagate();
<a name="l00690"></a>00690 }
<a name="l00691"></a>00691 
<a name="l00692"></a>00692 <span class="keywordtype">void</span> Assembly::update_active(EUROPA::TokenId <span class="keyword">const</span> &amp;tok) {
<a name="l00693"></a>00693   EUROPA::TokenId active = tok-&gt;getActiveToken();
<a name="l00694"></a>00694   
<a name="l00695"></a>00695   <span class="keywordflow">if</span>( active.isId() ) {
<a name="l00696"></a>00696     active-&gt;start()-&gt;restrictBaseDomain(tok-&gt;start()-&gt;baseDomain());
<a name="l00697"></a>00697     active-&gt;duration()-&gt;restrictBaseDomain(tok-&gt;duration()-&gt;baseDomain());
<a name="l00698"></a>00698     active-&gt;end()-&gt;restrictBaseDomain(tok-&gt;end()-&gt;baseDomain());
<a name="l00699"></a>00699     
<a name="l00700"></a>00700     std::vector&lt;EUROPA::ConstrainedVariableId&gt; <span class="keyword">const</span> &amp;attrs = tok-&gt;parameters();
<a name="l00701"></a>00701     <span class="keywordflow">for</span>(std::vector&lt;EUROPA::ConstrainedVariableId&gt;::const_iterator v=attrs.begin();
<a name="l00702"></a>00702         attrs.end()!=v; ++v)
<a name="l00703"></a>00703       active-&gt;getVariable((*v)-&gt;getName())-&gt;restrictBaseDomain((*v)-&gt;baseDomain());
<a name="l00704"></a>00704   }
<a name="l00705"></a>00705 }
<a name="l00706"></a>00706 
<a name="l00707"></a>00707 <span class="keywordtype">void</span> Assembly::completed(EUROPA::TokenId  <span class="keyword">const</span> &amp;token) {
<a name="l00708"></a>00708   remove_goal(token);
<a name="l00709"></a>00709   m_terminated.insert(token);
<a name="l00710"></a>00710 }
<a name="l00711"></a>00711 
<a name="l00712"></a>00712 <span class="keywordtype">bool</span> Assembly::archive() {
<a name="l00713"></a>00713   EUROPA::eint cur = currentTick();
<a name="l00714"></a>00714   
<a name="l00715"></a>00715   <span class="keywordflow">if</span>( inactive() &amp;&amp; !m_terminated.empty() ) {
<a name="l00716"></a>00716     EUROPA::TokenSet cands = m_terminated, removed;
<a name="l00717"></a>00717     
<a name="l00718"></a>00718     <span class="keywordflow">for</span>(EUROPA::TokenSet::const_iterator t=cands.begin(); cands.end()!=t; ++t) {
<a name="l00719"></a>00719       <span class="keywordflow">if</span>( (*t)-&gt;isInactive() )
<a name="l00720"></a>00720         removed.insert(*t);
<a name="l00721"></a>00721       <span class="keywordflow">else</span> {
<a name="l00722"></a>00722         EUROPA::TokenId active = *t;
<a name="l00723"></a>00723         
<a name="l00724"></a>00724         <span class="keywordflow">if</span>( (*t)-&gt;isMerged() ) {
<a name="l00725"></a>00725           active = (*t)-&gt;getActiveToken();
<a name="l00726"></a>00726           <span class="keywordflow">if</span>( (*t)-&gt;isFact() )
<a name="l00727"></a>00727             active-&gt;makeFact();
<a name="l00728"></a>00728           update_active(*t);
<a name="l00729"></a>00729           removed.insert(*t);
<a name="l00730"></a>00730           completed(active);
<a name="l00731"></a>00731         }
<a name="l00732"></a>00732         EUROPA::TokenSet tokens = active-&gt;getMergedTokens();
<a name="l00733"></a>00733         
<a name="l00734"></a>00734         <span class="keywordflow">for</span>(EUROPA::TokenSet::const_iterator m=tokens.begin(); tokens.end()!=m; ++m) {
<a name="l00735"></a>00735           <span class="keywordflow">if</span>( remove_goal(*m) ) {
<a name="l00736"></a>00736             update_active(*m);
<a name="l00737"></a>00737             removed.insert(*m);
<a name="l00738"></a>00738           }
<a name="l00739"></a>00739         }
<a name="l00740"></a>00740         active-&gt;restrictBaseDomains();
<a name="l00741"></a>00741         <span class="keywordflow">if</span>( active-&gt;canBeTerminated(cur) )
<a name="l00742"></a>00742           active-&gt;terminate();
<a name="l00743"></a>00743         
<a name="l00744"></a>00744         tokens = active-&gt;slaves();
<a name="l00745"></a>00745         <span class="keywordtype">bool</span> can_discard = active-&gt;isTerminated();
<a name="l00746"></a>00746         
<a name="l00747"></a>00747         <span class="keywordflow">for</span>(EUROPA::TokenSet::const_iterator s=tokens.begin(); tokens.end()!=s; ++s) {
<a name="l00748"></a>00748           <span class="keywordflow">if</span>( (*s)-&gt;isInactive() ) {
<a name="l00749"></a>00749             <span class="keywordflow">if</span>( (*s)-&gt;end()-&gt;lastDomain().getUpperBound()&lt;=cur )
<a name="l00750"></a>00750               removed.insert(*s);
<a name="l00751"></a>00751             <span class="keywordflow">else</span> 
<a name="l00752"></a>00752               can_discard = <span class="keyword">false</span>;
<a name="l00753"></a>00753           } <span class="keywordflow">else</span> {
<a name="l00754"></a>00754             EUROPA::TokenId slave = *s;
<a name="l00755"></a>00755             <span class="keywordflow">if</span>( slave-&gt;isMerged() ) {
<a name="l00756"></a>00756               update_active(slave);
<a name="l00757"></a>00757               removed.insert(slave);
<a name="l00758"></a>00758               slave = slave-&gt;getActiveToken();
<a name="l00759"></a>00759             }
<a name="l00760"></a>00760             <span class="keywordflow">if</span>( slave-&gt;start()-&gt;lastDomain().getUpperBound()&lt;=cur ) {
<a name="l00761"></a>00761               <span class="keywordflow">if</span>( slave-&gt;canBeCommitted() )
<a name="l00762"></a>00762                 slave-&gt;commit();
<a name="l00763"></a>00763               <span class="keywordflow">if</span>( slave-&gt;end()-&gt;lastDomain().getUpperBound()&lt;=cur ) {
<a name="l00764"></a>00764                 slave-&gt;start()-&gt;restrictBaseDomain(slave-&gt;start()-&gt;lastDomain());
<a name="l00765"></a>00765                 slave-&gt;duration()-&gt;restrictBaseDomain(slave-&gt;duration()-&gt;lastDomain());
<a name="l00766"></a>00766                 slave-&gt;end()-&gt;restrictBaseDomain(slave-&gt;end()-&gt;lastDomain());
<a name="l00767"></a>00767                 completed(slave);
<a name="l00768"></a>00768                 (*s)-&gt;removeMaster(active);
<a name="l00769"></a>00769               } <span class="keywordflow">else</span> 
<a name="l00770"></a>00770                 can_discard= <span class="keyword">false</span>;
<a name="l00771"></a>00771             } <span class="keywordflow">else</span> 
<a name="l00772"></a>00772               can_discard = <span class="keyword">false</span>;
<a name="l00773"></a>00773           }
<a name="l00774"></a>00774         }
<a name="l00775"></a>00775         <span class="keywordflow">if</span>( can_discard ) 
<a name="l00776"></a>00776           removed.insert(active);
<a name="l00777"></a>00777       }
<a name="l00778"></a>00778     }
<a name="l00779"></a>00779     
<a name="l00780"></a>00780     <span class="keywordflow">for</span>(EUROPA::TokenSet::const_iterator t=removed.begin(); removed.end()!=t; ++t) {
<a name="l00781"></a>00781       std::cout&lt;&lt;name()&lt;&lt;<span class="stringliteral">&quot;[&quot;</span>&lt;&lt;cur&lt;&lt;<span class="stringliteral">&quot;]  - Removing &quot;</span>&lt;&lt;(*t)-&gt;toString()&lt;&lt;std::endl;
<a name="l00782"></a>00782       <span class="keywordflow">if</span>( (*t)-&gt;isMerged() )
<a name="l00783"></a>00783         update_active(*t);
<a name="l00784"></a>00784       (*t)-&gt;discard();
<a name="l00785"></a>00785     }
<a name="l00786"></a>00786   }
<a name="l00787"></a>00787   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00788"></a>00788 }
<a name="l00789"></a>00789 
<a name="l00790"></a>00790 
<a name="l00791"></a>00791 <span class="keywordtype">bool</span> Assembly::step() {  
<a name="l00792"></a>00792   <span class="keywordflow">if</span>( propagate() ) {
<a name="l00793"></a>00793     <span class="keywordflow">if</span>( inactive() )
<a name="l00794"></a>00794       m_state = ACTIVE;
<a name="l00795"></a>00795     <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a1f28e61dc187fce2ba1950e3a179acf9" title="Get the solver.">solver</a>().step();
<a name="l00796"></a>00796     <span class="keywordflow">if</span>( <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a1f28e61dc187fce2ba1950e3a179acf9" title="Get the solver.">solver</a>().noMoreFlaws() ) {
<a name="l00797"></a>00797       debugMsg(<span class="stringliteral">&quot;trex:step&quot;</span>, <span class="stringliteral">&quot;[&quot;</span>&lt;&lt;currentTick()&lt;&lt;<span class="stringliteral">&quot;] Deliberation completed (steps=&quot;</span>
<a name="l00798"></a>00798                &lt;&lt;<a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a1f28e61dc187fce2ba1950e3a179acf9" title="Get the solver.">solver</a>().getStepCount()&lt;&lt;<span class="stringliteral">&quot;, depth=&quot;</span>&lt;&lt;<a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a1f28e61dc187fce2ba1950e3a179acf9" title="Get the solver.">solver</a>().getDepth()&lt;&lt;<span class="stringliteral">&quot;).&quot;</span>);
<a name="l00799"></a>00799       <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a1f28e61dc187fce2ba1950e3a179acf9" title="Get the solver.">solver</a>().clear(); <span class="comment">// reset solver state without changing the plan</span>
<a name="l00800"></a>00800                         <span class="comment">// this allow us to mess with the plan wihtout </span>
<a name="l00801"></a>00801                         <span class="comment">// &quot;trashing&quot; the decision stack of the solver</span>
<a name="l00802"></a>00802       m_state = INACTIVE;
<a name="l00803"></a>00803       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00804"></a>00804     }
<a name="l00805"></a>00805   }
<a name="l00806"></a>00806   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00807"></a>00807 }
<a name="l00808"></a>00808 
<a name="l00809"></a>00809 
<a name="l00810"></a>00810 <span class="keywordtype">bool</span> Assembly::propagate() {
<a name="l00811"></a>00811   <span class="keywordflow">if</span>( invalid() ) 
<a name="l00812"></a>00812     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00813"></a>00813   <span class="keywordflow">if</span>( !m_cstr_engine-&gt;propagate() ) {
<a name="l00814"></a>00814     <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a0b55b90ff316db2264004f2131f09d20" title="Log TREX message.">log</a>(<span class="stringliteral">&quot;&quot;</span>)&lt;&lt;<span class="stringliteral">&quot;Inconsistent plan (see &quot;</span>&lt;&lt;name()&lt;&lt;<span class="stringliteral">&quot;.europa.log for details)&quot;</span>;
<a name="l00815"></a>00815     propagation_failure();
<a name="l00816"></a>00816     mark_invalid();
<a name="l00817"></a>00817   }
<a name="l00818"></a>00818   <span class="keywordflow">return</span> !invalid();
<a name="l00819"></a>00819 }
<a name="l00820"></a>00820 
<a name="l00821"></a>00821 <span class="keywordtype">void</span> Assembly::propagation_failure() {
<a name="l00822"></a>00822   std::ostringstream msg;
<a name="l00823"></a>00823   
<a name="l00824"></a>00824   <span class="keywordflow">if</span>( !m_cstr_engine-&gt;constraintConsistent() ) {
<a name="l00825"></a>00825     msg&lt;&lt;<span class="stringliteral">&quot;Constraint network is inconsitent:\n&quot;</span>;
<a name="l00826"></a>00826     EUROPA::ConstrainedVariableSet <span class="keyword">const</span> &amp;vars=m_cstr_engine-&gt;getVariables();
<a name="l00827"></a>00827     EUROPA::ConstrainedVariableSet::const_iterator v=vars.begin();
<a name="l00828"></a>00828     
<a name="l00829"></a>00829     <span class="keywordflow">for</span>(; vars.end()!=v; ++v) {
<a name="l00830"></a>00830       <span class="keywordflow">if</span>( (*v)-&gt;lastDomain().isEmpty() &amp;&amp; (*v)-&gt;lastDomain().isClosed() ) {
<a name="l00831"></a>00831         EUROPA::TokenId token = details::parent_token(*v);
<a name="l00832"></a>00832         std::string prefix;
<a name="l00833"></a>00833         
<a name="l00834"></a>00834         <span class="keywordflow">if</span>( token.isId() ) {
<a name="l00835"></a>00835           std::ostringstream pfx;
<a name="l00836"></a>00836           
<a name="l00837"></a>00837           pfx&lt;&lt;token-&gt;getName().toString()&lt;&lt;<span class="charliteral">&#39;(&#39;</span>&lt;&lt;token-&gt;getKey()&lt;&lt;<span class="stringliteral">&quot;).&quot;</span>;
<a name="l00838"></a>00838           prefix = pfx.str();
<a name="l00839"></a>00839         }
<a name="l00840"></a>00840         msg&lt;&lt;<span class="stringliteral">&quot; - Local context of &quot;</span>&lt;&lt;prefix&lt;&lt;(*v)-&gt;getName().toString()&lt;&lt;<span class="stringliteral">&quot;:\n&quot;</span>
<a name="l00841"></a>00841         &lt;&lt;<span class="stringliteral">&quot;    - base domain: &quot;</span>&lt;&lt;(*v)-&gt;baseDomain().toString()&lt;&lt;<span class="charliteral">&#39;\n&#39;</span>
<a name="l00842"></a>00842         &lt;&lt;<span class="stringliteral">&quot;    - derived domain: &quot;</span>&lt;&lt;(*v)-&gt;lastDomain().toString()&lt;&lt;<span class="charliteral">&#39;\n&#39;</span>
<a name="l00843"></a>00843         &lt;&lt;<span class="stringliteral">&quot;    - Europa explanation: &quot;</span>&lt;&lt;(*v)-&gt;getViolationExpl()&lt;&lt;<span class="charliteral">&#39;\n&#39;</span>;
<a name="l00844"></a>00844         
<a name="l00845"></a>00845         EUROPA::ConstraintSet constraints;
<a name="l00846"></a>00846         (*v)-&gt;constraints(constraints);
<a name="l00847"></a>00847         <span class="keywordflow">if</span>( ! constraints.empty() ) {
<a name="l00848"></a>00848           msg&lt;&lt;<span class="stringliteral">&quot;    - related constraints:\n&quot;</span>;
<a name="l00849"></a>00849           EUROPA::ConstraintSet::const_iterator c=constraints.begin();
<a name="l00850"></a>00850           <span class="keywordflow">for</span>( ; constraints.end()!=c; ++c) {
<a name="l00851"></a>00851             std::vector&lt;EUROPA::ConstrainedVariableId&gt; <span class="keyword">const</span> &amp;args = (*c)-&gt;getScope();
<a name="l00852"></a>00852             <span class="keywordtype">size_t</span> idx;
<a name="l00853"></a>00853             
<a name="l00854"></a>00854             msg&lt;&lt;<span class="stringliteral">&quot;       + &quot;</span>&lt;&lt;(*c)-&gt;getName().toString()&lt;&lt;<span class="charliteral">&#39;(&#39;</span>;
<a name="l00855"></a>00855             <span class="keywordflow">for</span>(idx=0; idx&lt;args.size(); ++idx) {
<a name="l00856"></a>00856               <span class="keywordflow">if</span>( idx&gt;0 )
<a name="l00857"></a>00857                 msg&lt;&lt;<span class="stringliteral">&quot;, &quot;</span>;
<a name="l00858"></a>00858               token = details::parent_token(args[idx]);
<a name="l00859"></a>00859               <span class="keywordflow">if</span>( token.isId() )
<a name="l00860"></a>00860                 msg&lt;&lt;token-&gt;getName().toString()&lt;&lt;<span class="charliteral">&#39;(&#39;</span>&lt;&lt;token-&gt;getKey()&lt;&lt;<span class="stringliteral">&quot;).&quot;</span>;
<a name="l00861"></a>00861               msg&lt;&lt;args[idx];
<a name="l00862"></a>00862               <span class="keywordflow">if</span>( args[idx]!=*v )
<a name="l00863"></a>00863                 msg&lt;&lt;<span class="stringliteral">&quot;=&quot;</span>&lt;&lt;args[idx]-&gt;lastDomain().toString();
<a name="l00864"></a>00864             }
<a name="l00865"></a>00865             msg&lt;&lt;<span class="stringliteral">&quot;)\n&quot;</span>;
<a name="l00866"></a>00866           }
<a name="l00867"></a>00867         }
<a name="l00868"></a>00868       }
<a name="l00869"></a>00869     }
<a name="l00870"></a>00870     debugMsg(<span class="stringliteral">&quot;trex:always&quot;</span>, msg.str());
<a name="l00871"></a>00871   }
<a name="l00872"></a>00872 }
<a name="l00873"></a>00873 
<a name="l00874"></a>00874 <span class="comment">/*</span>
<a name="l00875"></a>00875 <span class="comment"> * class TREX::europa::Assembly::TokenManager</span>
<a name="l00876"></a>00876 <span class="comment"> */</span>
<a name="l00877"></a>00877 
<a name="l00878"></a>00878 <span class="comment">// manipulators </span>
<a name="l00879"></a>00879 
<a name="l00880"></a>00880 <span class="keywordtype">bool</span> Assembly::TokenManager::process_agenda(<a class="code" href="../../da/da1/classTREX_1_1europa_1_1Assembly_1_1TokenProcessor.html">Assembly::TokenProcessor</a> &amp;sync) {
<a name="l00881"></a>00881   <span class="comment">// Process the facts first </span>
<a name="l00882"></a>00882   <span class="keywordflow">if</span>( !process_agenda(m_facts_agenda, sync) ) {
<a name="l00883"></a>00883     debugMsg(<span class="stringliteral">&quot;trex:sync&quot;</span>, <span class="stringliteral">&quot;Failed to resolve facts.&quot;</span>);
<a name="l00884"></a>00884     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00885"></a>00885   }
<a name="l00886"></a>00886   <span class="comment">// Then process other tokens</span>
<a name="l00887"></a>00887   <span class="keywordflow">if</span>( !process_agenda(m_agenda, sync) ) {
<a name="l00888"></a>00888     debugMsg(<span class="stringliteral">&quot;trex:sync&quot;</span>, <span class="stringliteral">&quot;Failed to resolve tokens.&quot;</span>);
<a name="l00889"></a>00889     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00890"></a>00890   }  
<a name="l00891"></a>00891   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00892"></a>00892 }
<a name="l00893"></a>00893 
<a name="l00894"></a>00894 <span class="keywordtype">bool</span> Assembly::TokenManager::process_agenda(EUROPA::TokenSet agenda, 
<a name="l00895"></a>00895                                             <a class="code" href="../../da/da1/classTREX_1_1europa_1_1Assembly_1_1TokenProcessor.html">Assembly::TokenProcessor</a> &amp;sync) {
<a name="l00896"></a>00896   <span class="keywordflow">for</span>(EUROPA::TokenSet::const_iterator i=agenda.begin(); agenda.end()!=i; ++i) 
<a name="l00897"></a>00897     <span class="keywordflow">if</span>( !m_assembly.in_deliberation(*i) ) <span class="comment">// filter out the tokens handled by the solver</span>
<a name="l00898"></a>00898       <span class="keywordflow">if</span>( sync.accept(*i) &amp;&amp; !sync.resolve(*i) ) {
<a name="l00899"></a>00899         m_assembly.mark_invalid();
<a name="l00900"></a>00900         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00901"></a>00901       }
<a name="l00902"></a>00902   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00903"></a>00903 }
<a name="l00904"></a>00904 
<a name="l00905"></a>00905 
<a name="l00906"></a>00906 <span class="comment">// modifiers </span>
<a name="l00907"></a>00907 
<a name="l00908"></a>00908 <span class="keywordtype">void</span> Assembly::TokenManager::add_to_agenda(EUROPA::TokenId <span class="keyword">const</span> &amp;tok) {
<a name="l00909"></a>00909   <span class="keywordflow">if</span>( tok-&gt;isFact() )
<a name="l00910"></a>00910     m_facts_agenda.insert(tok);
<a name="l00911"></a>00911   <span class="keywordflow">else</span>
<a name="l00912"></a>00912     m_agenda.insert(tok);
<a name="l00913"></a>00913 }
<a name="l00914"></a>00914 
<a name="l00915"></a>00915 <span class="keywordtype">void</span> Assembly::TokenManager::remove_from_agenda(EUROPA::TokenId <span class="keyword">const</span> &amp;tok) {
<a name="l00916"></a>00916   <span class="keywordflow">if</span>( tok-&gt;isFact() )
<a name="l00917"></a>00917     m_facts_agenda.erase(tok);
<a name="l00918"></a>00918   <span class="keywordflow">else</span>
<a name="l00919"></a>00919     m_agenda.erase(tok);
<a name="l00920"></a>00920 }
<a name="l00921"></a>00921 
<a name="l00922"></a>00922 <span class="comment">// callbacks</span>
<a name="l00923"></a>00923 
<a name="l00924"></a>00924 <span class="keywordtype">void</span> Assembly::TokenManager::notifyAdded(EUROPA::TokenId <span class="keyword">const</span> &amp;token) {
<a name="l00925"></a>00925   debugMsg(<span class="stringliteral">&quot;trex:token&quot;</span>, <span class="stringliteral">&quot;ADD &quot;</span>&lt;&lt;token-&gt;toString()&lt;&lt;<span class="stringliteral">&quot;: &quot;</span>&lt;&lt;token-&gt;getPredicateName().toString());
<a name="l00926"></a>00926   <span class="keywordflow">if</span>( !m_assembly.isIgnored(token) )
<a name="l00927"></a>00927     <span class="keywordflow">if</span>( token-&gt;isInactive() )
<a name="l00928"></a>00928       add_to_agenda(token);
<a name="l00929"></a>00929 }
<a name="l00930"></a>00930 
<a name="l00931"></a>00931 <span class="keywordtype">void</span> Assembly::TokenManager::notifyRemoved(EUROPA::TokenId <span class="keyword">const</span> &amp;token) {
<a name="l00932"></a>00932   debugMsg(<span class="stringliteral">&quot;trex:token&quot;</span>, <span class="stringliteral">&quot;REMOVE &quot;</span>&lt;&lt;token-&gt;toString());
<a name="l00933"></a>00933   m_assembly.remove_goal(token);
<a name="l00934"></a>00934   remove_from_agenda(token);
<a name="l00935"></a>00935   m_assembly.m_terminated.erase(token);
<a name="l00936"></a>00936 }
<a name="l00937"></a>00937 
<a name="l00938"></a>00938 <span class="keywordtype">void</span> Assembly::TokenManager::notifyActivated(EUROPA::TokenId <span class="keyword">const</span> &amp;token) {
<a name="l00939"></a>00939   debugMsg(<span class="stringliteral">&quot;trex:token&quot;</span>, <span class="stringliteral">&quot;ACTIVE &quot;</span>&lt;&lt;token-&gt;toString());
<a name="l00940"></a>00940   remove_from_agenda(token);
<a name="l00941"></a>00941 }
<a name="l00942"></a>00942 
<a name="l00943"></a>00943 <span class="keywordtype">void</span> Assembly::TokenManager::notifyDeactivated(EUROPA::TokenId <span class="keyword">const</span> &amp;token) {
<a name="l00944"></a>00944   debugMsg(<span class="stringliteral">&quot;trex:token&quot;</span>, <span class="stringliteral">&quot;INACTIVE &quot;</span>&lt;&lt;token-&gt;toString());
<a name="l00945"></a>00945   add_to_agenda(token);
<a name="l00946"></a>00946 }
<a name="l00947"></a>00947 
<a name="l00948"></a>00948 <span class="keywordtype">void</span> Assembly::TokenManager::notifyMerged(EUROPA::TokenId <span class="keyword">const</span> &amp;token) {
<a name="l00949"></a>00949   debugMsg(<span class="stringliteral">&quot;trex:token&quot;</span>, <span class="stringliteral">&quot;MERGE &quot;</span>&lt;&lt;token-&gt;toString());
<a name="l00950"></a>00950   remove_from_agenda(token);
<a name="l00951"></a>00951 }
<a name="l00952"></a>00952 
<a name="l00953"></a>00953 <span class="keywordtype">void</span> Assembly::TokenManager::notifySplit(EUROPA::TokenId <span class="keyword">const</span> &amp;token) {
<a name="l00954"></a>00954   debugMsg(<span class="stringliteral">&quot;trex:token&quot;</span>, <span class="stringliteral">&quot;SPLIT &quot;</span>&lt;&lt;token-&gt;toString());
<a name="l00955"></a>00955   add_to_agenda(token);
<a name="l00956"></a>00956 }
<a name="l00957"></a>00957 
<a name="l00958"></a>00958 <span class="keywordtype">void</span> Assembly::TokenManager::notifyCommitted(EUROPA::TokenId <span class="keyword">const</span> &amp;token) {
<a name="l00959"></a>00959   debugMsg(<span class="stringliteral">&quot;trex:token&quot;</span>, <span class="stringliteral">&quot;COMMIT &quot;</span>&lt;&lt;token-&gt;toString());
<a name="l00960"></a>00960   <span class="keywordflow">if</span>( m_assembly.isInternal(token) ) {
<a name="l00961"></a>00961     std::cout&lt;&lt;<span class="stringliteral">&quot;New observation\n&quot;</span>&lt;&lt;token-&gt;toLongString()&lt;&lt;std::endl;    
<a name="l00962"></a>00962   }
<a name="l00963"></a>00963 }
<a name="l00964"></a>00964 
<a name="l00965"></a>00965 <span class="keywordtype">void</span> Assembly::TokenManager::notifyRejected(EUROPA::TokenId <span class="keyword">const</span> &amp;token) {
<a name="l00966"></a>00966   debugMsg(<span class="stringliteral">&quot;trex:token&quot;</span>, <span class="stringliteral">&quot;REJECT &quot;</span>&lt;&lt;token-&gt;toString());
<a name="l00967"></a>00967   remove_from_agenda(token);  
<a name="l00968"></a>00968 }
<a name="l00969"></a>00969 
<a name="l00970"></a>00970 <span class="keywordtype">void</span> Assembly::TokenManager::notifyTerminated(EUROPA::TokenId <span class="keyword">const</span> &amp;token) {
<a name="l00971"></a>00971   debugMsg(<span class="stringliteral">&quot;trex:token&quot;</span>, <span class="stringliteral">&quot;TERMINATE &quot;</span>&lt;&lt;token-&gt;toString());
<a name="l00972"></a>00972   remove_from_agenda(token);
<a name="l00973"></a>00973   m_assembly.m_terminated.insert(token);
<a name="l00974"></a>00974 }
<a name="l00975"></a>00975 
<a name="l00976"></a>00976 
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Wed Dec 14 14:40:10 2011 for trex by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
