<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>trex: extra/europa2.old/old/Assembly.cc Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='../../open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='../../closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='../../closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="../../main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../dirs.html"><span>Directories</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="../../files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="../../globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="../../dir_a032f23e96409494e74a59edbe6bc8e5.html">extra</a>&nbsp;&raquo;&nbsp;<a class="el" href="../../dir_aadc07d4d9c472d12b4c06eadec554c7.html">europa2.old</a>&nbsp;&raquo;&nbsp;<a class="el" href="../../dir_3c0f2fdc9174b5a6a5f9f08926374db1.html">old</a>
  </div>
</div>
<div class="contents">
<h1>Assembly.cc</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*********************************************************************</span>
<a name="l00002"></a>00002 <span class="comment"> * Software License Agreement (BSD License)</span>
<a name="l00003"></a>00003 <span class="comment"> * </span>
<a name="l00004"></a>00004 <span class="comment"> *  Copyright (c) 2011, MBARI.</span>
<a name="l00005"></a>00005 <span class="comment"> *  All rights reserved.</span>
<a name="l00006"></a>00006 <span class="comment"> * </span>
<a name="l00007"></a>00007 <span class="comment"> *  Redistribution and use in source and binary forms, with or without</span>
<a name="l00008"></a>00008 <span class="comment"> *  modification, are permitted provided that the following conditions</span>
<a name="l00009"></a>00009 <span class="comment"> *  are met:</span>
<a name="l00010"></a>00010 <span class="comment"> * </span>
<a name="l00011"></a>00011 <span class="comment"> *   * Redistributions of source code must retain the above copyright</span>
<a name="l00012"></a>00012 <span class="comment"> *     notice, this list of conditions and the following disclaimer.</span>
<a name="l00013"></a>00013 <span class="comment"> *   * Redistributions in binary form must reproduce the above</span>
<a name="l00014"></a>00014 <span class="comment"> *     copyright notice, this list of conditions and the following</span>
<a name="l00015"></a>00015 <span class="comment"> *     disclaimer in the documentation and/or other materials provided</span>
<a name="l00016"></a>00016 <span class="comment"> *     with the distribution.</span>
<a name="l00017"></a>00017 <span class="comment"> *   * Neither the name of the TREX Project nor the names of its</span>
<a name="l00018"></a>00018 <span class="comment"> *     contributors may be used to endorse or promote products derived</span>
<a name="l00019"></a>00019 <span class="comment"> *     from this software without specific prior written permission.</span>
<a name="l00020"></a>00020 <span class="comment"> * </span>
<a name="l00021"></a>00021 <span class="comment"> *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<a name="l00022"></a>00022 <span class="comment"> *  &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<a name="l00023"></a>00023 <span class="comment"> *  LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</span>
<a name="l00024"></a>00024 <span class="comment"> *  FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE</span>
<a name="l00025"></a>00025 <span class="comment"> *  COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<a name="l00026"></a>00026 <span class="comment"> *  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span>
<a name="l00027"></a>00027 <span class="comment"> *  BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;</span>
<a name="l00028"></a>00028 <span class="comment"> *  LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span>
<a name="l00029"></a>00029 <span class="comment"> *  CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
<a name="l00030"></a>00030 <span class="comment"> *  LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN</span>
<a name="l00031"></a>00031 <span class="comment"> *  ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<a name="l00032"></a>00032 <span class="comment"> *  POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00033"></a>00033 <span class="comment"> */</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;Assembly.hh&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;DbSolver.hh&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;DeliberationFilter.hh&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;Constraints.hh&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;EuropaReactor.hh&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;TokenManager.hh&quot;</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;private/Schema.hh&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;private/ReactorPropagator.hh&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;bits/europa_types.hh&quot;</span>
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;PLASMA/ModuleConstraintEngine.hh&gt;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;PLASMA/ModulePlanDatabase.hh&gt;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &lt;PLASMA/ModuleRulesEngine.hh&gt;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;PLASMA/ModuleTemporalNetwork.hh&gt;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &lt;PLASMA/ModuleSolvers.hh&gt;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &lt;PLASMA/ModuleNddl.hh&gt;</span>
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="preprocessor">#include &lt;PLASMA/RulesEngine.hh&gt;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &lt;PLASMA/Propagators.hh&gt;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &lt;PLASMA/Schema.hh&gt;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &lt;PLASMA/NddlInterpreter.hh&gt;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &lt;PLASMA/TokenVariable.hh&gt;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &lt;PLASMA/Timeline.hh&gt;</span>
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 <span class="preprocessor">#include &lt;boost/algorithm/string/replace.hpp&gt;</span>
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 <span class="keyword">using namespace </span>TREX::europa;
<a name="l00063"></a>00063 <span class="keyword">using namespace </span>TREX::utils;
<a name="l00064"></a>00064 <span class="keyword">using namespace </span>TREX::transaction;
<a name="l00065"></a>00065 <span class="keyword">namespace </span>xml = boost::property_tree::xml_parser;
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 <span class="keyword">namespace </span>{
<a name="l00068"></a>00068 
<a name="l00092"></a>00092   <span class="keyword">class </span>DefaultSchema :<span class="keyword">public</span> <a class="code" href="../../d9/dab/classTREX_1_1europa_1_1SchemaPlugin.html" title="Europa extension &amp;quot;plug-in&amp;quot;.">SchemaPlugin</a> {
<a name="l00093"></a>00093   <span class="keyword">public</span>:
<a name="l00094"></a>00094     <span class="keywordtype">void</span> registerComponents(<a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html" title="Interface toward europa.">Assembly</a> <span class="keyword">const</span> &amp;assembly);
<a name="l00095"></a>00095   }; <span class="comment">// ::DefaultSchema</span>
<a name="l00096"></a>00096 
<a name="l00097"></a>00097   <span class="keywordtype">void</span> DefaultSchema::registerComponents(<a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html" title="Interface toward europa.">Assembly</a> <span class="keyword">const</span> &amp;assembly) {
<a name="l00098"></a>00098     <span class="comment">// declare the filter used for maintaining reactor look-ahead</span>
<a name="l00099"></a>00099     TREX_REGISTER_FLAW_FILTER(assembly, <a class="code" href="../../d6/dc0/classTREX_1_1europa_1_1DeliberationFilter.html">TREX::europa::DeliberationFilter</a>,
<a name="l00100"></a>00100                            <a class="code" href="../../d6/dc0/classTREX_1_1europa_1_1DeliberationFilter.html">DeliberationFilter</a>);
<a name="l00101"></a>00101     <span class="comment">// declare few TREX utility constraints</span>
<a name="l00102"></a>00102     TREX_REGISTER_CONSTRAINT(assembly, <a class="code" href="../../d3/d09/classTREX_1_1europa_1_1CheckExternal.html" title="Check if External.">TREX::europa::CheckExternal</a>, <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#ad7f0982e42c8c434e0944e7ea7ba8178" title="Check if external.">isExternal</a>, trex);
<a name="l00103"></a>00103     TREX_REGISTER_CONSTRAINT(assembly, <a class="code" href="../../db/d52/classTREX_1_1europa_1_1CheckInternal.html" title="Check if Internal.">TREX::europa::CheckInternal</a>, <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#afffd4a905c450497e2818523dd264057" title="Check if internal.">isInternal</a>, trex);
<a name="l00104"></a>00104     TREX_REGISTER_CONSTRAINT(assembly, <a class="code" href="../../d2/d95/classTREX_1_1europa_1_1Bind.html" title="Variable binding constraint.">TREX::europa::Bind</a>, bind, trex);
<a name="l00105"></a>00105   }
<a name="l00106"></a>00106 
<a name="l00107"></a>00107   DefaultSchema trex_schema;
<a name="l00108"></a>00108 
<a name="l00109"></a>00109 }
<a name="l00110"></a>00110 
<a name="l00111"></a>00111 <span class="comment">/*</span>
<a name="l00112"></a>00112 <span class="comment"> * class TREX::europa::TokenError</span>
<a name="l00113"></a>00113 <span class="comment"> */</span> 
<a name="l00114"></a>00114 
<a name="l00115"></a>00115 <span class="comment">// structors </span>
<a name="l00116"></a>00116 TokenError::TokenError(EUROPA::Token <span class="keyword">const</span> &amp;tok, std::string <span class="keyword">const</span> &amp;msg) <span class="keywordflow">throw</span>() 
<a name="l00117"></a>00117   :<a class="code" href="../../dd/d3e/classTREX_1_1europa_1_1EuropaException.html" title="Europa related error.">EuropaException</a>(msg+<span class="stringliteral">&quot;; on token \n\t&quot;</span>+tok.toLongString()) {}
<a name="l00118"></a>00118 
<a name="l00119"></a>00119 <span class="comment">/*</span>
<a name="l00120"></a>00120 <span class="comment"> * class TREX::europa::Assembly</span>
<a name="l00121"></a>00121 <span class="comment"> */</span>
<a name="l00122"></a>00122 
<a name="l00123"></a>00123 <span class="comment">// statics </span>
<a name="l00124"></a>00124 
<a name="l00125"></a>00125 EUROPA::LabelStr <span class="keyword">const</span> Assembly::TREX_TIMELINE(<span class="stringliteral">&quot;AgentTimeline&quot;</span>);
<a name="l00126"></a>00126 std::string <span class="keyword">const</span>       Assembly::MODE_ATTR(<span class="stringliteral">&quot;mode&quot;</span>);
<a name="l00127"></a>00127 EUROPA::LabelStr <span class="keyword">const</span>   Assembly::EXTERNAL_MODE(<span class="stringliteral">&quot;External&quot;</span>);
<a name="l00128"></a>00128 EUROPA::LabelStr <span class="keyword">const</span>   Assembly::OBSERVE_MODE(<span class="stringliteral">&quot;Observe&quot;</span>);
<a name="l00129"></a>00129 EUROPA::LabelStr <span class="keyword">const</span>   Assembly::INTERNAL_MODE(<span class="stringliteral">&quot;Internal&quot;</span>);
<a name="l00130"></a>00130 EUROPA::LabelStr <span class="keyword">const</span>   Assembly::PRIVATE_MODE(<span class="stringliteral">&quot;Private&quot;</span>);
<a name="l00131"></a>00131 EUROPA::LabelStr <span class="keyword">const</span>   Assembly::IGNORE_MODE(<span class="stringliteral">&quot;Ignore&quot;</span>);
<a name="l00132"></a>00132 std::string <span class="keyword">const</span>       Assembly::DEFAULT_ATTR(<span class="stringliteral">&quot;defaultPredicate&quot;</span>);
<a name="l00133"></a>00133 std::string <span class="keyword">const</span>        Assembly::UNDEFINED_PRED(<span class="stringliteral">&quot;undefined&quot;</span>);
<a name="l00134"></a>00134 
<a name="l00135"></a>00135 EUROPA::LabelStr <span class="keyword">const</span> Assembly::MISSION_END(<span class="stringliteral">&quot;MISSION_END&quot;</span>);
<a name="l00136"></a>00136 EUROPA::LabelStr <span class="keyword">const</span> Assembly::TICK_DURATION(<span class="stringliteral">&quot;TICK_DURATION&quot;</span>);
<a name="l00137"></a>00137 EUROPA::LabelStr <span class="keyword">const</span> Assembly::CLOCK_VAR(<span class="stringliteral">&quot;AGENT_CLOCK&quot;</span>);
<a name="l00138"></a>00138 
<a name="l00139"></a>00139 <span class="comment">// structors </span>
<a name="l00140"></a>00140 
<a name="l00141"></a>00141 Assembly::Assembly(<a class="code" href="../../d5/dba/classTREX_1_1europa_1_1EuropaReactor.html" title="Europa based deliberative reactor.">EuropaReactor</a> &amp;owner)
<a name="l00142"></a>00142   :m_state(<a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html" title="Interface toward europa.">Assembly</a>::INVALID), m_reactor(owner), m_solver(NULL), m_agenda(NULL) {
<a name="l00143"></a>00143   <span class="comment">// Create the europa debug output file</span>
<a name="l00144"></a>00144   m_trex_schema-&gt;setStream(m_dbg_output, name().str()+<span class="stringliteral">&quot;.europa.log&quot;</span>);
<a name="l00145"></a>00145   
<a name="l00146"></a>00146   <span class="comment">// Create the europa modules we need</span>
<a name="l00147"></a>00147   addModule((<span class="keyword">new</span> EUROPA::ModuleConstraintEngine())-&gt;getId());
<a name="l00148"></a>00148   addModule((<span class="keyword">new</span> EUROPA::ModuleConstraintLibrary())-&gt;getId());
<a name="l00149"></a>00149   addModule((<span class="keyword">new</span> EUROPA::ModulePlanDatabase())-&gt;getId());
<a name="l00150"></a>00150   addModule((<span class="keyword">new</span> EUROPA::ModuleRulesEngine())-&gt;getId());
<a name="l00151"></a>00151   addModule((<span class="keyword">new</span> EUROPA::ModuleTemporalNetwork())-&gt;getId());
<a name="l00152"></a>00152   addModule((<span class="keyword">new</span> EUROPA::ModuleSolvers())-&gt;getId());
<a name="l00153"></a>00153   addModule((<span class="keyword">new</span> EUROPA::ModuleNddl())-&gt;getId());
<a name="l00154"></a>00154 
<a name="l00155"></a>00155   <span class="comment">// terminate the intialization of the base class</span>
<a name="l00156"></a>00156   doStart();
<a name="l00157"></a>00157   
<a name="l00158"></a>00158   <span class="comment">// initialize the europa entry points</span>
<a name="l00159"></a>00159   m_europa_schema = <span class="keyword">dynamic_cast&lt;</span>EUROPA::Schema *<span class="keyword">&gt;</span>(getComponent(<span class="stringliteral">&quot;Schema&quot;</span>))-&gt;getId();
<a name="l00160"></a>00160   m_cstr_engine = <span class="keyword">dynamic_cast&lt;</span>EUROPA::ConstraintEngine *<span class="keyword">&gt;</span>(getComponent(<span class="stringliteral">&quot;ConstraintEngine&quot;</span>))-&gt;getId();
<a name="l00161"></a>00161   m_plan_db = <span class="keyword">dynamic_cast&lt;</span>EUROPA::PlanDatabase *<span class="keyword">&gt;</span>(getComponent(<span class="stringliteral">&quot;PlanDatabase&quot;</span>))-&gt;getId();
<a name="l00162"></a>00162   m_rules_engine = <span class="keyword">dynamic_cast&lt;</span>EUROPA::RulesEngine *<span class="keyword">&gt;</span>(getComponent(<span class="stringliteral">&quot;RulesEngine&quot;</span>))-&gt;getId();
<a name="l00163"></a>00163 
<a name="l00164"></a>00164   <span class="comment">// Register our TREX specific propagator</span>
<a name="l00165"></a>00165   <span class="keyword">new</span> <a class="code" href="../../d9/da5/classTREX_1_1europa_1_1ReactorPropagator.html" title="TREX specific propagator.">ReactorPropagator</a>(*<span class="keyword">this</span>, EUROPA::LabelStr(<span class="stringliteral">&quot;trex&quot;</span>), m_cstr_engine);
<a name="l00166"></a>00166 
<a name="l00167"></a>00167   <span class="comment">// deactivate auto propagation so we can control when it is done</span>
<a name="l00168"></a>00168   m_cstr_engine-&gt;setAutoPropagation(<span class="keyword">false</span>);
<a name="l00169"></a>00169 
<a name="l00170"></a>00170   <span class="comment">// get all the europa extensions currently loaded </span>
<a name="l00171"></a>00171   m_trex_schema-&gt;registerComponents(*<span class="keyword">this</span>);
<a name="l00172"></a>00172   m_agenda = <span class="keyword">new</span> <a class="code" href="../../d6/d70/classTREX_1_1europa_1_1TokenManager.html">TokenManager</a>(*<span class="keyword">this</span>);
<a name="l00173"></a>00173 
<a name="l00174"></a>00174   EUROPA::DomainComparator::setComparator((EUROPA::Schema *)m_europa_schema);
<a name="l00175"></a>00175 }
<a name="l00176"></a>00176 
<a name="l00177"></a>00177 Assembly::~Assembly() {
<a name="l00178"></a>00178   <span class="keywordflow">if</span>( NULL!=m_agenda ) {
<a name="l00179"></a>00179     <span class="keyword">delete</span> m_agenda;
<a name="l00180"></a>00180     m_agenda = NULL;
<a name="l00181"></a>00181   }
<a name="l00182"></a>00182   <span class="keywordflow">if</span>( NULL!=m_solver ) {
<a name="l00183"></a>00183     <span class="keyword">delete</span> m_solver;
<a name="l00184"></a>00184     m_solver = NULL;
<a name="l00185"></a>00185   }
<a name="l00186"></a>00186   doShutdown();
<a name="l00187"></a>00187 }
<a name="l00188"></a>00188 
<a name="l00189"></a>00189 <span class="comment">// observers </span>
<a name="l00190"></a>00190 
<a name="l00191"></a>00191 <a class="code" href="../../dc/de0/classTREX_1_1utils_1_1BasicSymbol.html" title="generic symbol class">Symbol</a> Assembly::name()<span class="keyword"> const </span>{
<a name="l00192"></a>00192   <span class="keywordflow">return</span> m_reactor.<a class="code" href="../../df/d7a/classTREX_1_1transaction_1_1TeleoReactor.html#a8facf8e8ea1ba386fa07bffb25881379" title="Reactor name.">getName</a>();
<a name="l00193"></a>00193 }
<a name="l00194"></a>00194 
<a name="l00195"></a>00195 <span class="keywordtype">void</span> <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a89f8c5ced5458f76a4a0b3000d16c9df" title="Get trex timelines.">Assembly::trex_timelines</a>(std::list&lt;EUROPA::ObjectId&gt; &amp;timelines)<span class="keyword"> const </span>{
<a name="l00196"></a>00196   <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a4b1156d1afeaaa97638ba63025b1ff02" title="Get europa plan database.">plan_db</a>()-&gt;getObjectsByType(<a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#ad095f7f9e7d1a5cc8e25c4de95c64317" title="TREX agent timelines.">TREX_TIMELINE</a>, timelines);
<a name="l00197"></a>00197 }
<a name="l00198"></a>00198 
<a name="l00199"></a>00199 <span class="keywordtype">bool</span> Assembly::isAgentTimeline(EUROPA::ObjectId <span class="keyword">const</span> &amp;obj)<span class="keyword"> const </span>{
<a name="l00200"></a>00200   <span class="keywordflow">return</span> <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#acefaf2dd910ec5609ad7c682649507f9" title="Get europa schema.">schema</a>()-&gt;isA(obj-&gt;getType(), <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#ad095f7f9e7d1a5cc8e25c4de95c64317" title="TREX agent timelines.">TREX_TIMELINE</a>);
<a name="l00201"></a>00201 }
<a name="l00202"></a>00202 
<a name="l00203"></a>00203 <span class="keywordtype">bool</span> Assembly::isAgentTimeline(EUROPA::DataTypeId <span class="keyword">const</span> &amp;type)<span class="keyword"> const </span>{
<a name="l00204"></a>00204   <span class="keywordflow">return</span> <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#acefaf2dd910ec5609ad7c682649507f9" title="Get europa schema.">schema</a>()-&gt;isA(type-&gt;getName(), <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#ad095f7f9e7d1a5cc8e25c4de95c64317" title="TREX agent timelines.">TREX_TIMELINE</a>);
<a name="l00205"></a>00205 }
<a name="l00206"></a>00206 
<a name="l00207"></a>00207 <span class="keywordtype">bool</span> <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#ad7f0982e42c8c434e0944e7ea7ba8178" title="Check if external.">Assembly::isExternal</a>(EUROPA::ObjectId <span class="keyword">const</span> &amp;obj)<span class="keyword"> const </span>{
<a name="l00208"></a>00208   <span class="keywordflow">return</span> isAgentTimeline(obj) &amp;&amp; m_reactor.<a class="code" href="../../df/d7a/classTREX_1_1transaction_1_1TeleoReactor.html#a41d3bf0d0663f3ff4469686dc6878d01" title="Check for exeternal timeline.">isExternal</a>(obj-&gt;getName().toString());
<a name="l00209"></a>00209 }
<a name="l00210"></a>00210 
<a name="l00211"></a>00211 <span class="keywordtype">bool</span> <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#afffd4a905c450497e2818523dd264057" title="Check if internal.">Assembly::isInternal</a>(EUROPA::ObjectId <span class="keyword">const</span> &amp;obj)<span class="keyword"> const </span>{
<a name="l00212"></a>00212   <span class="keywordflow">return</span> isAgentTimeline(obj) &amp;&amp; m_reactor.<a class="code" href="../../df/d7a/classTREX_1_1transaction_1_1TeleoReactor.html#a9d8c2a89f8940138216a1f7821adfb04" title="Check for internal timeline.">isInternal</a>(obj-&gt;getName().toString());
<a name="l00213"></a>00213 }
<a name="l00214"></a>00214 
<a name="l00215"></a>00215 <span class="keywordtype">bool</span> <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a0b9c957c0fd4990ca285ce91657dc518" title="Check if ignored.">Assembly::isIgnored</a>(EUROPA::TokenId <span class="keyword">const</span> &amp;tok)<span class="keyword"> const </span>{
<a name="l00216"></a>00216   <span class="keywordflow">if</span>( m_ignored_toks.end()==m_ignored_toks.find(tok) ) {
<a name="l00217"></a>00217     <span class="comment">// This token is not explicitiely ignored =&gt; check if its object is ignored</span>
<a name="l00218"></a>00218     EUROPA::ObjectDomain <span class="keyword">const</span> &amp;dom(tok-&gt;getObject()-&gt;lastDomain());
<a name="l00219"></a>00219     std::list&lt;EUROPA::ObjectId&gt; objs=dom.makeObjectList();
<a name="l00220"></a>00220 
<a name="l00221"></a>00221     <span class="keywordflow">for</span>(std::list&lt;EUROPA::ObjectId&gt;::const_iterator i=objs.begin();
<a name="l00222"></a>00222        objs.end()!=i; ++i) 
<a name="l00223"></a>00223       <span class="keywordflow">if</span>( !<a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a0b9c957c0fd4990ca285ce91657dc518" title="Check if ignored.">isIgnored</a>(*i) ) {
<a name="l00224"></a>00224        <span class="comment">// There&#39;s at least on possible object which is not ignored</span>
<a name="l00225"></a>00225        <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00226"></a>00226       }
<a name="l00227"></a>00227     <span class="comment">// All the possible objects are ignored =&gt; just check that the object domain is not empty</span>
<a name="l00228"></a>00228     <span class="keywordflow">return</span> !objs.empty();
<a name="l00229"></a>00229   } <span class="keywordflow">else</span> {
<a name="l00230"></a>00230     <span class="comment">// This token is part of the expicitely ignored tokens</span>
<a name="l00231"></a>00231     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00232"></a>00232   }
<a name="l00233"></a>00233 }
<a name="l00234"></a>00234 
<a name="l00235"></a>00235 EUROPA::ConstrainedVariableId <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a06b420836c583ae74b464d9985be3435" title="Extract an object attribute.">Assembly::attribute</a>(EUROPA::ObjectId <span class="keyword">const</span> &amp;obj,
<a name="l00236"></a>00236                                             std::string <span class="keyword">const</span> &amp;name)<span class="keyword"> const </span>{
<a name="l00237"></a>00237   <span class="comment">// Build the varaibale full name</span>
<a name="l00238"></a>00238   std::string full_name(obj-&gt;getName().toString()+<span class="stringliteral">&quot;.&quot;</span>+name);
<a name="l00239"></a>00239   <span class="comment">// Extract the attribute from obj</span>
<a name="l00240"></a>00240   EUROPA::ConstrainedVariableId var(obj-&gt;getVariable(full_name));
<a name="l00241"></a>00241 
<a name="l00242"></a>00242   <span class="keywordflow">if</span>( var.isNoId() )
<a name="l00243"></a>00243     <span class="keywordflow">throw</span> <a class="code" href="../../dd/d3e/classTREX_1_1europa_1_1EuropaException.html" title="Europa related error.">EuropaException</a>(<span class="stringliteral">&quot;Variable \&quot;&quot;</span>+full_name+<span class="stringliteral">&quot;\&quot; doe not exist.&quot;</span>);
<a name="l00244"></a>00244   <span class="keywordflow">return</span> var;
<a name="l00245"></a>00245 }
<a name="l00246"></a>00246 
<a name="l00247"></a>00247 <a class="code" href="../../da/d38/classTREX_1_1utils_1_1internals_1_1LogEntry.html" title="Text Entry manager for TextLog.">TREX::utils::internals::LogEntry</a> <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a0b55b90ff316db2264004f2131f09d20" title="Log TREX message.">Assembly::log</a>(std::string <span class="keyword">const</span> &amp;context)<span class="keyword"> const </span>{
<a name="l00248"></a>00248   <span class="keywordflow">return</span> m_reactor.<a class="code" href="../../df/d7a/classTREX_1_1transaction_1_1TeleoReactor.html#abde1d28e37984ab0a0ae71a6023bcd8b" title="new log entry">syslog</a>(context);
<a name="l00249"></a>00249 }
<a name="l00250"></a>00250 
<a name="l00251"></a>00251 <span class="keywordtype">void</span> Assembly::log_propagation_failure()<span class="keyword"> const </span>{
<a name="l00252"></a>00252   std::ostringstream msg;
<a name="l00253"></a>00253   
<a name="l00254"></a>00254   <span class="keywordflow">if</span>( !m_cstr_engine-&gt;constraintConsistent() ) {
<a name="l00255"></a>00255     msg&lt;&lt;<span class="stringliteral">&quot;Constraint network is inconsitent:\n&quot;</span>;
<a name="l00256"></a>00256     
<a name="l00257"></a>00257     EUROPA::ConstrainedVariableSet <span class="keyword">const</span> &amp;vars = m_cstr_engine-&gt;getVariables();
<a name="l00258"></a>00258     EUROPA::ConstrainedVariableSet::const_iterator v=vars.begin();
<a name="l00259"></a>00259     
<a name="l00260"></a>00260     <span class="keywordflow">for</span>( ; vars.end()!=v; ++v) {
<a name="l00261"></a>00261       <span class="keywordflow">if</span>( (*v)-&gt;lastDomain().isEmpty() &amp;&amp; (*v)-&gt;lastDomain().isClosed() ) {
<a name="l00262"></a>00262         <span class="comment">// Found an inconsistent variable</span>
<a name="l00263"></a>00263         EUROPA::TokenId tok = details::parent_token(*v);
<a name="l00264"></a>00264         std::string prefix;
<a name="l00265"></a>00265         
<a name="l00266"></a>00266         <span class="keywordflow">if</span>( tok.isId() ){
<a name="l00267"></a>00267           std::ostringstream pfx;
<a name="l00268"></a>00268           pfx&lt;&lt;tok-&gt;getName().toString()&lt;&lt;<span class="charliteral">&#39;(&#39;</span>&lt;&lt;tok-&gt;getKey()&lt;&lt;<span class="stringliteral">&quot;).&quot;</span>;
<a name="l00269"></a>00269           prefix = pfx.str();
<a name="l00270"></a>00270         }
<a name="l00271"></a>00271         msg&lt;&lt;<span class="stringliteral">&quot; - Local context for empty variable &quot;</span>&lt;&lt;prefix&lt;&lt;(*v)-&gt;getName().toString()&lt;&lt;<span class="stringliteral">&quot;:\n&quot;</span>
<a name="l00272"></a>00272            &lt;&lt;<span class="stringliteral">&quot;   - base domain : &quot;</span>&lt;&lt;(*v)-&gt;baseDomain().toString()&lt;&lt;<span class="charliteral">&#39;\n&#39;</span>
<a name="l00273"></a>00273            &lt;&lt;<span class="stringliteral">&quot;   - Europa explanation : &quot;</span>&lt;&lt;(*v)-&gt;getViolationExpl()&lt;&lt;<span class="charliteral">&#39;\n&#39;</span>;
<a name="l00274"></a>00274         
<a name="l00275"></a>00275         <span class="comment">// Now I show all the constraints involved directly with v</span>
<a name="l00276"></a>00276         EUROPA::ConstraintSet constraints;
<a name="l00277"></a>00277         (*v)-&gt;constraints(constraints);
<a name="l00278"></a>00278         <span class="keywordflow">if</span>( constraints.empty() ) {
<a name="l00279"></a>00279           msg&lt;&lt;<span class="stringliteral">&quot;   - No related constraint: someone did tweak this variable under the hood.&quot;</span>; 
<a name="l00280"></a>00280         } <span class="keywordflow">else</span> {
<a name="l00281"></a>00281           EUROPA::ConstraintSet::const_iterator c = constraints.begin();
<a name="l00282"></a>00282           msg&lt;&lt;<span class="stringliteral">&quot;   - Related constraints:\n&quot;</span>;
<a name="l00283"></a>00283           
<a name="l00284"></a>00284           <span class="keywordflow">for</span>( ; constraints.end()!=c; ++c) {
<a name="l00285"></a>00285             std::vector&lt;EUROPA::ConstrainedVariableId&gt; <span class="keyword">const</span> &amp;scope = (*c)-&gt;getScope();
<a name="l00286"></a>00286 
<a name="l00287"></a>00287             msg&lt;&lt;<span class="stringliteral">&quot;     + &quot;</span>&lt;&lt;(*c)-&gt;getName().toString()&lt;&lt;<span class="charliteral">&#39;(&#39;</span>;
<a name="l00288"></a>00288             <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> idx=0; idx&lt;scope.size(); ++idx) {
<a name="l00289"></a>00289               <span class="keywordflow">if</span>( idx&gt;0 )
<a name="l00290"></a>00290                 msg&lt;&lt;<span class="stringliteral">&quot;, &quot;</span>;
<a name="l00291"></a>00291               tok = details::parent_token(scope[idx]);
<a name="l00292"></a>00292               <span class="keywordflow">if</span>( tok.isId() )
<a name="l00293"></a>00293                 msg&lt;&lt;tok-&gt;getName().toString()&lt;&lt;<span class="charliteral">&#39;(&#39;</span>&lt;&lt;tok-&gt;getKey()&lt;&lt;<span class="stringliteral">&quot;).&quot;</span>;
<a name="l00294"></a>00294               msg&lt;&lt;scope[idx]-&gt;getName().toString();
<a name="l00295"></a>00295               <span class="keywordflow">if</span>( scope[idx]!=*v )
<a name="l00296"></a>00296                 msg&lt;&lt;<span class="charliteral">&#39;=&#39;</span>&lt;&lt;scope[idx]-&gt;lastDomain().toString();
<a name="l00297"></a>00297             }
<a name="l00298"></a>00298             msg&lt;&lt;<span class="stringliteral">&quot;)\n&quot;</span>;
<a name="l00299"></a>00299           }
<a name="l00300"></a>00300         }
<a name="l00301"></a>00301       }
<a name="l00302"></a>00302     }
<a name="l00303"></a>00303     debugMsg(<span class="stringliteral">&quot;trex:always&quot;</span>, msg.str());
<a name="l00304"></a>00304   }
<a name="l00305"></a>00305 }
<a name="l00306"></a>00306 
<a name="l00307"></a>00307 
<a name="l00308"></a>00308 <span class="comment">// manipulators</span>
<a name="l00309"></a>00309 
<a name="l00310"></a>00310 <span class="keywordtype">bool</span> <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a032b448b67f81e5f1ddc21ea5fac9ba9" title="Load a model.">Assembly::playTransaction</a>(std::string <span class="keyword">const</span> &amp;nddl) {
<a name="l00311"></a>00311   <span class="keywordtype">bool</span> found;
<a name="l00312"></a>00312   std::string config;
<a name="l00313"></a>00313 
<a name="l00314"></a>00314   <span class="comment">// Attempt to locate nddl configuration file </span>
<a name="l00315"></a>00315   config = m_reactor.<a class="code" href="../../df/d7a/classTREX_1_1transaction_1_1TeleoReactor.html#a975231dd2846e0a806833f93d79dabb5" title="LogManager acces point.">manager</a>().<a class="code" href="../../d2/d8b/classTREX_1_1utils_1_1LogManager.html#abd315b6112cd5975b4af4cf710afb629" title="Configuration files management.">use</a>(<span class="stringliteral">&quot;NDDL.cfg&quot;</span>, found);
<a name="l00316"></a>00316   <span class="keywordflow">if</span>( !found ) {
<a name="l00317"></a>00317     config = m_reactor.<a class="code" href="../../df/d7a/classTREX_1_1transaction_1_1TeleoReactor.html#a975231dd2846e0a806833f93d79dabb5" title="LogManager acces point.">manager</a>().<a class="code" href="../../d2/d8b/classTREX_1_1utils_1_1LogManager.html#abd315b6112cd5975b4af4cf710afb629" title="Configuration files management.">use</a>(<span class="stringliteral">&quot;temp_nddl_gen.cfg&quot;</span>, found);
<a name="l00318"></a>00318     <span class="keywordflow">if</span>( !found )
<a name="l00319"></a>00319       <span class="keywordflow">throw</span> <a class="code" href="../../d6/d6d/classTREX_1_1transaction_1_1ReactorException.html" title="TeleoReactor related exception.">ReactorException</a>(m_reactor,
<a name="l00320"></a>00320                           <span class="stringliteral">&quot;Unable to locate NDDL.cfg or temp_nddl_gen.cfg&quot;</span>);
<a name="l00321"></a>00321   }
<a name="l00322"></a>00322   <span class="comment">// parse the configuration file</span>
<a name="l00323"></a>00323   boost::property_tree::ptree cfg;
<a name="l00324"></a>00324   read_xml(config, cfg, xml::no_comments|xml::trim_whitespace);
<a name="l00325"></a>00325 
<a name="l00326"></a>00326   <span class="keywordflow">if</span>( cfg.empty() ) 
<a name="l00327"></a>00327     <span class="keywordflow">throw</span> <a class="code" href="../../d6/d6d/classTREX_1_1transaction_1_1ReactorException.html" title="TeleoReactor related exception.">ReactorException</a>(m_reactor, 
<a name="l00328"></a>00328                         config+<span class="stringliteral">&quot; europa config does not appear to have any XML content.&quot;</span>);
<a name="l00329"></a>00329   <span class="keywordflow">else</span> <span class="keywordflow">if</span>( cfg.size()!=1 )
<a name="l00330"></a>00330     <span class="keywordflow">throw</span> <a class="code" href="../../d6/d6d/classTREX_1_1transaction_1_1ReactorException.html" title="TeleoReactor related exception.">ReactorException</a>(m_reactor, 
<a name="l00331"></a>00331                         config+<span class="stringliteral">&quot; europa config have mutiple XML roots.&quot;</span>);
<a name="l00332"></a>00332   <span class="comment">// extract &lt;include /&gt; tags to buyild the nddl path</span>
<a name="l00333"></a>00333   boost::property_tree::ptree::assoc_iterator i, last;
<a name="l00334"></a>00334   boost::tie(i, last) = cfg.front().second.equal_range(<span class="stringliteral">&quot;include&quot;</span>);
<a name="l00335"></a>00335   <span class="keywordflow">for</span>( ; last!=i; ++i) {
<a name="l00336"></a>00336     std::string path = parse_attr&lt;std::string&gt;(*i, <span class="stringliteral">&quot;path&quot;</span>);
<a name="l00337"></a>00337     <span class="comment">// replace &#39;;&#39; by &#39;:&#39;</span>
<a name="l00338"></a>00338     boost::replace_all(path, <span class="stringliteral">&quot;;&quot;</span>, <span class="stringliteral">&quot;:&quot;</span>);
<a name="l00339"></a>00339     <span class="comment">// Add this path to the nddl interpreter</span>
<a name="l00340"></a>00340     getLanguageInterpreter(<span class="stringliteral">&quot;nddl&quot;</span>)-&gt;getEngine()-&gt;getConfig()-&gt;setProperty(<span class="stringliteral">&quot;nddl.includePath&quot;</span>, path);
<a name="l00341"></a>00341   }
<a name="l00342"></a>00342   <span class="comment">// Lastly inject the TREX_PATH</span>
<a name="l00343"></a>00343   std::ostringstream oss;
<a name="l00344"></a>00344   oss&lt;&lt;<span class="charliteral">&#39;.&#39;</span>;
<a name="l00345"></a>00345   <span class="keywordflow">for</span>(<a class="code" href="../../d2/d8b/classTREX_1_1utils_1_1LogManager.html#ac9e33406d5d59fa8be27922e9d0d2e9e" title="TREX_PATH iterator.">LogManager::path_iterator</a> i=m_reactor.<a class="code" href="../../df/d7a/classTREX_1_1transaction_1_1TeleoReactor.html#a975231dd2846e0a806833f93d79dabb5" title="LogManager acces point.">manager</a>().<a class="code" href="../../d2/d8b/classTREX_1_1utils_1_1LogManager.html#a67dd30f0e14b79d9f60643cb4c275de4" title="First path.">begin</a>();
<a name="l00346"></a>00346       m_reactor.<a class="code" href="../../df/d7a/classTREX_1_1transaction_1_1TeleoReactor.html#a975231dd2846e0a806833f93d79dabb5" title="LogManager acces point.">manager</a>().<a class="code" href="../../d2/d8b/classTREX_1_1utils_1_1LogManager.html#a1bd090554dbe669e46c81b85676da896" title="End of searh path.">end</a>()!=i; ++i)
<a name="l00347"></a>00347     oss&lt;&lt;<span class="charliteral">&#39;:&#39;</span>&lt;&lt;*i;
<a name="l00348"></a>00348   getLanguageInterpreter(<span class="stringliteral">&quot;nddl&quot;</span>)-&gt;getEngine()-&gt;getConfig()-&gt;setProperty(<span class="stringliteral">&quot;nddl.includePath&quot;</span>, oss.str());
<a name="l00349"></a>00349 
<a name="l00350"></a>00350   <span class="comment">// Now is time to parse the content of the nddl file</span>
<a name="l00351"></a>00351   std::string ret;
<a name="l00352"></a>00352   <span class="keywordflow">try</span> {
<a name="l00353"></a>00353     ret = executeScript(<span class="stringliteral">&quot;nddl&quot;</span>, nddl, <span class="keyword">true</span>);
<a name="l00354"></a>00354   } <span class="keywordflow">catch</span>(EUROPA::PSLanguageExceptionList <span class="keyword">const</span> &amp;le) {
<a name="l00355"></a>00355     std::ostringstream err;
<a name="l00356"></a>00356     err&lt;&lt;<span class="stringliteral">&quot;Error during \&quot;&quot;</span>&lt;&lt;nddl&lt;&lt;<span class="stringliteral">&quot;\&quot; parsing:\n&quot;</span>&lt;&lt;le;
<a name="l00357"></a>00357     <span class="keywordflow">throw</span> <a class="code" href="../../d6/d6d/classTREX_1_1transaction_1_1ReactorException.html" title="TeleoReactor related exception.">ReactorException</a>(m_reactor, err.str());
<a name="l00358"></a>00358   } <span class="keywordflow">catch</span>(Error <span class="keyword">const</span> &amp;ee) {
<a name="l00359"></a>00359     <span class="keywordflow">throw</span> <a class="code" href="../../d6/d6d/classTREX_1_1transaction_1_1ReactorException.html" title="TeleoReactor related exception.">ReactorException</a>(m_reactor, 
<a name="l00360"></a>00360                         <span class="stringliteral">&quot;Error during \&quot;&quot;</span>+nddl+<span class="stringliteral">&quot;\&quot; parsing:\n&quot;</span>+ee.getMsg());
<a name="l00361"></a>00361   }
<a name="l00362"></a>00362   <span class="keywordflow">if</span>( !ret.empty() ) 
<a name="l00363"></a>00363     <span class="keywordflow">throw</span> <a class="code" href="../../d6/d6d/classTREX_1_1transaction_1_1ReactorException.html" title="TeleoReactor related exception.">ReactorException</a>(m_reactor, 
<a name="l00364"></a>00364                         <span class="stringliteral">&quot;Error during \&quot;&quot;</span>+nddl+<span class="stringliteral">&quot;\&quot; parsing:\n&quot;</span>+ret);
<a name="l00365"></a>00365   <span class="comment">// Model was loaded : check that it is consistent</span>
<a name="l00366"></a>00366   <span class="keywordflow">return</span> m_cstr_engine-&gt;constraintConsistent();
<a name="l00367"></a>00367 }
<a name="l00368"></a>00368 
<a name="l00369"></a>00369 <span class="keywordtype">void</span> <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#ac7a07eda65e94bcdbf3926d8eba20d00" title="That plan solver configuration.">Assembly::configure_solver</a>(std::string <span class="keyword">const</span> &amp;cfg) {
<a name="l00370"></a>00370   <span class="keywordflow">if</span>( NULL==m_solver ) {
<a name="l00371"></a>00371     <span class="keywordtype">bool</span> found;
<a name="l00372"></a>00372     std::string file = m_reactor.<a class="code" href="../../df/d7a/classTREX_1_1transaction_1_1TeleoReactor.html#a975231dd2846e0a806833f93d79dabb5" title="LogManager acces point.">manager</a>().<a class="code" href="../../d2/d8b/classTREX_1_1utils_1_1LogManager.html#abd315b6112cd5975b4af4cf710afb629" title="Configuration files management.">use</a>(cfg, found);
<a name="l00373"></a>00373 
<a name="l00374"></a>00374     <span class="keywordflow">if</span>( !found )
<a name="l00375"></a>00375       <span class="keywordflow">throw</span> <a class="code" href="../../d6/d6d/classTREX_1_1transaction_1_1ReactorException.html" title="TeleoReactor related exception.">ReactorException</a>(m_reactor, 
<a name="l00376"></a>00376                           <span class="stringliteral">&quot;Unable to locate solver config \&quot;&quot;</span>+cfg+<span class="stringliteral">&quot;\&quot;&quot;</span>);
<a name="l00377"></a>00377     
<a name="l00378"></a>00378     <span class="comment">// Extract the XML content using europa representation</span>
<a name="l00379"></a>00379     std::auto_ptr&lt;EUROPA::TiXmlElement&gt; xml(EUROPA::initXml(file.c_str()));
<a name="l00380"></a>00380     
<a name="l00381"></a>00381     <span class="keywordflow">if</span>( NULL==xml.get() )
<a name="l00382"></a>00382       <span class="keywordflow">throw</span> <a class="code" href="../../d6/d6d/classTREX_1_1transaction_1_1ReactorException.html" title="TeleoReactor related exception.">ReactorException</a>(m_reactor,
<a name="l00383"></a>00383                           <span class="stringliteral">&quot;Unable to parse XML content of \&quot;&quot;</span>+cfg+<span class="stringliteral">&quot;\&quot;&quot;</span>);
<a name="l00384"></a>00384 
<a name="l00385"></a>00385     <span class="comment">// Insert the deliberation filter in the xml</span>
<a name="l00386"></a>00386     <span class="comment">// ther dshould be a better way</span>
<a name="l00387"></a>00387     EUROPA::TiXmlElement filter(<span class="stringliteral">&quot;FlawFilter&quot;</span>);
<a name="l00388"></a>00388     filter.SetAttribute(<span class="stringliteral">&quot;component&quot;</span>, <span class="stringliteral">&quot;DeliberationFilter&quot;</span>);
<a name="l00389"></a>00389     xml-&gt;InsertBeforeChild(xml-&gt;FirstChild(), filter);
<a name="l00390"></a>00390     
<a name="l00391"></a>00391     <span class="comment">// Set the current Assembly to this instance</span>
<a name="l00392"></a>00392     DeliberationFilter::set_current(<span class="keyword">this</span>);
<a name="l00393"></a>00393     m_solver = <span class="keyword">new</span> <a class="code" href="../../de/d89/classTREX_1_1europa_1_1DbSolver.html">DbSolver</a>(*<span class="keyword">this</span>, *xml);    
<a name="l00394"></a>00394   } <span class="keywordflow">else</span> 
<a name="l00395"></a>00395     <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a0b55b90ff316db2264004f2131f09d20" title="Log TREX message.">log</a>(<span class="stringliteral">&quot;WARN&quot;</span>)&lt;&lt;<span class="stringliteral">&quot;Attempted to configure this solver more than once.&quot;</span>; 
<a name="l00396"></a>00396 }
<a name="l00397"></a>00397 
<a name="l00398"></a>00398 <span class="keywordtype">void</span> <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#ac60bbbf3170e277bcaf0690589f56002" title="Set final tick.">Assembly::setFinalTick</a>(<a class="code" href="../../db/db4/group__transaction.html#ga71ccb7c46d43d3d538c401886b341ada" title="TREX unit of time.">TICK</a> value) {
<a name="l00399"></a>00399   EUROPA::ConstrainedVariableId 
<a name="l00400"></a>00400      mission_end = <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a4b1156d1afeaaa97638ba63025b1ff02" title="Get europa plan database.">plan_db</a>()-&gt;getGlobalVariable(<a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#ab4ddfc1746112972d3e1502c1c33a7b1" title="Europa mission end variable.">MISSION_END</a>);
<a name="l00401"></a>00401   <span class="keywordflow">if</span>( mission_end.isNoId() ) 
<a name="l00402"></a>00402     <span class="keywordflow">throw</span> <a class="code" href="../../d6/d6d/classTREX_1_1transaction_1_1ReactorException.html" title="TeleoReactor related exception.">ReactorException</a>(m_reactor, <span class="stringliteral">&quot;Unable to locate &quot;</span>
<a name="l00403"></a>00403                            +<a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#ab4ddfc1746112972d3e1502c1c33a7b1" title="Europa mission end variable.">MISSION_END</a>.toString()+<span class="stringliteral">&quot; in the model.&quot;</span>);
<a name="l00404"></a>00404   mission_end-&gt;restrictBaseDomain(EUROPA::IntervalIntDomain(value));
<a name="l00405"></a>00405   
<a name="l00406"></a>00406   <span class="comment">// Prepare the clock</span>
<a name="l00407"></a>00407   m_clk = <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a4b1156d1afeaaa97638ba63025b1ff02" title="Get europa plan database.">plan_db</a>()-&gt;getGlobalVariable(CLOCK_VAR);
<a name="l00408"></a>00408   
<a name="l00409"></a>00409   <span class="keywordflow">if</span>( m_clk.isNoId() ) {
<a name="l00410"></a>00410     debugMsg(<span class="stringliteral">&quot;trex:always&quot;</span>, <span class="stringliteral">&quot;Unable to find variable &quot;</span>&lt;&lt;CLOCK_VAR.toString());
<a name="l00411"></a>00411     <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a0b55b90ff316db2264004f2131f09d20" title="Log TREX message.">log</a>(<span class="stringliteral">&quot;WARN&quot;</span>)&lt;&lt;<span class="stringliteral">&quot;I cannot find the variable &quot;</span>&lt;&lt;CLOCK_VAR.toString()&lt;&lt;<span class="stringliteral">&quot; in the model&quot;</span>;     
<a name="l00412"></a>00412   } <span class="keywordflow">else</span> {
<a name="l00413"></a>00413     m_clk-&gt;restrictBaseDomain(EUROPA::IntervalIntDomain(std::numeric_limits&lt;EUROPA::eint&gt;::minus_infinity(), 
<a name="l00414"></a>00414                                                       EUROPA::eint(value)));
<a name="l00415"></a>00415   }
<a name="l00416"></a>00416 }
<a name="l00417"></a>00417 
<a name="l00418"></a>00418 <span class="keywordtype">void</span> <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a4114f61586ade4269babbfc9cb86a3dc" title="Set tick duration.">Assembly::setTickFactor</a>(<span class="keywordtype">double</span> delta) {
<a name="l00419"></a>00419   EUROPA::ConstrainedVariableId 
<a name="l00420"></a>00420     tick_dur = <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a4b1156d1afeaaa97638ba63025b1ff02" title="Get europa plan database.">plan_db</a>()-&gt;getGlobalVariable(<a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a53b1f48299aef37e84148306cd38bba6" title="tick duration variable">TICK_DURATION</a>);
<a name="l00421"></a>00421   <span class="keywordflow">if</span>( tick_dur.isNoId() ) {
<a name="l00422"></a>00422     <span class="keywordflow">throw</span> <a class="code" href="../../d6/d6d/classTREX_1_1transaction_1_1ReactorException.html" title="TeleoReactor related exception.">ReactorException</a>(m_reactor, <span class="stringliteral">&quot;Unable to locate &quot;</span>
<a name="l00423"></a>00423                            +<a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a53b1f48299aef37e84148306cd38bba6" title="tick duration variable">TICK_DURATION</a>.toString()+<span class="stringliteral">&quot; in the model.&quot;</span>);
<a name="l00424"></a>00424   } <span class="keywordflow">else</span>
<a name="l00425"></a>00425     tick_dur-&gt;restrictBaseDomain(EUROPA::IntervalDomain(delta));
<a name="l00426"></a>00426 }
<a name="l00427"></a>00427 
<a name="l00428"></a>00428 
<a name="l00429"></a>00429 <span class="keywordtype">void</span> Assembly::setStream() {
<a name="l00430"></a>00430   m_trex_schema-&gt;setStream(m_dbg_output);
<a name="l00431"></a>00431 }
<a name="l00432"></a>00432 
<a name="l00433"></a>00433 <span class="keywordtype">void</span> <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#ad50cc53529886baedfa60d55e1b263a9" title="Check for default predicate.">Assembly::check_default</a>(EUROPA::ObjectId <span class="keyword">const</span> &amp;obj)<span class="keyword"> const </span>{
<a name="l00434"></a>00434   EUROPA::ConstrainedVariableId default_attr = <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a47eade9aea60af20038c558d447640e2" title="Get default predicate value.">default_pred</a>(obj);
<a name="l00435"></a>00435   std::ostringstream oss;
<a name="l00436"></a>00436   <span class="comment">// Get the default attribute</span>
<a name="l00437"></a>00437   <span class="keywordflow">if</span>( default_attr.isNoId() || !default_attr-&gt;isSpecified() ) { 
<a name="l00438"></a>00438     oss&lt;&lt;<span class="stringliteral">&quot;Internal timeline &quot;</span>&lt;&lt;obj-&gt;getName().toString()
<a name="l00439"></a>00439        &lt;&lt;<span class="stringliteral">&quot; does not specify its default attribute&quot;</span>;
<a name="l00440"></a>00440     <span class="keywordflow">throw</span> <a class="code" href="../../dd/d3e/classTREX_1_1europa_1_1EuropaException.html" title="Europa related error.">EuropaException</a>(oss.str());
<a name="l00441"></a>00441   }
<a name="l00442"></a>00442   <span class="comment">// Identify the predicate name</span>
<a name="l00443"></a>00443   EUROPA::DataTypeId type = default_attr-&gt;getDataType();
<a name="l00444"></a>00444   std::string short_pred = type-&gt;toString(default_attr-&gt;getSpecifiedValue()),
<a name="l00445"></a>00445     long_pred = obj-&gt;getType().toString()+<span class="stringliteral">&quot;.&quot;</span>+short_pred;
<a name="l00446"></a>00446   
<a name="l00447"></a>00447   <span class="keywordflow">if</span>( !<a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#acefaf2dd910ec5609ad7c682649507f9" title="Get europa schema.">schema</a>()-&gt;isPredicate(long_pred.c_str()) ) {
<a name="l00448"></a>00448     oss&lt;&lt;<span class="stringliteral">&quot;Internal timeline &quot;</span>&lt;&lt;obj-&gt;getName().toString()
<a name="l00449"></a>00449        &lt;&lt;<span class="stringliteral">&quot; default predicate \&quot;&quot;</span>&lt;&lt;short_pred&lt;&lt;<span class="stringliteral">&quot;\&quot; does not exist.&quot;</span>;
<a name="l00450"></a>00450     <span class="keywordflow">throw</span> <a class="code" href="../../dd/d3e/classTREX_1_1europa_1_1EuropaException.html" title="Europa related error.">EuropaException</a>(oss.str());
<a name="l00451"></a>00451   }
<a name="l00452"></a>00452 }
<a name="l00453"></a>00453 
<a name="l00454"></a>00454 
<a name="l00455"></a>00455 std::pair&lt;EUROPA::ObjectId, EUROPA::TokenId&gt; 
<a name="l00456"></a>00456 Assembly::convert(<a class="code" href="../../d4/db5/classTREX_1_1transaction_1_1Predicate.html" title="TREX Predicate.">TREX::transaction::Predicate</a> <span class="keyword">const</span> &amp;pred, <span class="keywordtype">bool</span> isFact) {
<a name="l00457"></a>00457   EUROPA::DbClientId cli = <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a4b1156d1afeaaa97638ba63025b1ff02" title="Get europa plan database.">plan_db</a>()-&gt;getClient();
<a name="l00458"></a>00458   EUROPA::TokenId token = EUROPA::TokenId::noId();
<a name="l00459"></a>00459   <span class="keywordtype">bool</span> rejectable = !isFact;
<a name="l00460"></a>00460   
<a name="l00461"></a>00461   <span class="comment">// Get the object in the plan database</span>
<a name="l00462"></a>00462   EUROPA::ObjectId timeline = cli-&gt;getObject(pred.<a class="code" href="../../d4/db5/classTREX_1_1transaction_1_1Predicate.html#a5e18c7846b0bfe674ccf60b5cf98aa9c" title="Predicate object.">object</a>().<a class="code" href="../../dc/de0/classTREX_1_1utils_1_1BasicSymbol.html#aa1d5585755293b04022fda519ebb25c0" title="String value.">str</a>().c_str());
<a name="l00463"></a>00463   <span class="comment">// Build the predicate name for Europa</span>
<a name="l00464"></a>00464   std::string 
<a name="l00465"></a>00465     pred_name = timeline-&gt;getType().toString()+<span class="stringliteral">&quot;.&quot;</span>+pred.<a class="code" href="../../d4/db5/classTREX_1_1transaction_1_1Predicate.html#a028ede642074b939f4d3b2a27ca2c47a" title="predicate type">predicate</a>().<a class="code" href="../../dc/de0/classTREX_1_1utils_1_1BasicSymbol.html#aa1d5585755293b04022fda519ebb25c0" title="String value.">str</a>();
<a name="l00466"></a>00466   
<a name="l00467"></a>00467   <span class="comment">// Check if the predicate exists </span>
<a name="l00468"></a>00468   <span class="keywordflow">if</span>( <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#acefaf2dd910ec5609ad7c682649507f9" title="Get europa schema.">schema</a>()-&gt;isPredicate(pred_name.c_str()) ) {
<a name="l00469"></a>00469     <span class="comment">// Create the new token</span>
<a name="l00470"></a>00470     token = cli-&gt;createToken(pred_name.c_str(), NULL, rejectable, isFact);
<a name="l00471"></a>00471 
<a name="l00472"></a>00472     <span class="keywordflow">if</span>( token.isId() ) {
<a name="l00473"></a>00473       <span class="comment">// Now I can restrict the attributes </span>
<a name="l00474"></a>00474       <span class="keywordflow">for</span>(Predicate::const_iterator i=pred.<a class="code" href="../../d4/db5/classTREX_1_1transaction_1_1Predicate.html#ad9f7d61308503a313ed0f525c3b26192" title="beginning of the attributes set">begin</a>(); pred.<a class="code" href="../../d4/db5/classTREX_1_1transaction_1_1Predicate.html#aa07342c1309d0fbaa5db219e83af3e43" title="end of the attributes set">end</a>()!=i; ++i) {
<a name="l00475"></a>00475         EUROPA::ConstrainedVariableId param = token-&gt;getVariable(i-&gt;first.str());
<a name="l00476"></a>00476         
<a name="l00477"></a>00477         <span class="keywordflow">if</span>( param.isId() ) {
<a name="l00478"></a>00478           <span class="keywordflow">try</span> {
<a name="l00479"></a>00479             <span class="comment">// This attribute exists =&gt; restrict its value</span>
<a name="l00480"></a>00480             details::europa_restrict(param, i-&gt;second.domain());
<a name="l00481"></a>00481           } <span class="keywordflow">catch</span>(<a class="code" href="../../db/d3a/classTREX_1_1transaction_1_1DomainExcept.html" title="Empty domain.">DomainExcept</a> <span class="keyword">const</span> &amp;err) {
<a name="l00482"></a>00482             <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a0b55b90ff316db2264004f2131f09d20" title="Log TREX message.">log</a>(<span class="stringliteral">&quot;WARN&quot;</span>)&lt;&lt;<span class="stringliteral">&quot;Failed to restrict attribute &quot;</span>&lt;&lt;i-&gt;first
<a name="l00483"></a>00483                        &lt;&lt;<span class="stringliteral">&quot; on token &quot;</span>&lt;&lt;pred.<a class="code" href="../../d4/db5/classTREX_1_1transaction_1_1Predicate.html#a5e18c7846b0bfe674ccf60b5cf98aa9c" title="Predicate object.">object</a>()&lt;&lt;<span class="charliteral">&#39;.&#39;</span>&lt;&lt;pred.<a class="code" href="../../d4/db5/classTREX_1_1transaction_1_1Predicate.html#a028ede642074b939f4d3b2a27ca2c47a" title="predicate type">predicate</a>()
<a name="l00484"></a>00484                        &lt;&lt;<span class="stringliteral">&quot;: &quot;</span>&lt;&lt;err;
<a name="l00485"></a>00485           }
<a name="l00486"></a>00486         } <span class="keywordflow">else</span>
<a name="l00487"></a>00487           <span class="comment">// Unknown attribute =&gt; ignore it</span>
<a name="l00488"></a>00488           <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a0b55b90ff316db2264004f2131f09d20" title="Log TREX message.">log</a>(<span class="stringliteral">&quot;WARN&quot;</span>)&lt;&lt;<span class="stringliteral">&quot;Unknown attribute &quot;</span>&lt;&lt;i-&gt;first
<a name="l00489"></a>00489                      &lt;&lt;<span class="stringliteral">&quot; on token &quot;</span>&lt;&lt;pred.<a class="code" href="../../d4/db5/classTREX_1_1transaction_1_1Predicate.html#a5e18c7846b0bfe674ccf60b5cf98aa9c" title="Predicate object.">object</a>()&lt;&lt;<span class="charliteral">&#39;.&#39;</span>&lt;&lt;pred.<a class="code" href="../../d4/db5/classTREX_1_1transaction_1_1Predicate.html#a028ede642074b939f4d3b2a27ca2c47a" title="predicate type">predicate</a>();
<a name="l00490"></a>00490       }
<a name="l00491"></a>00491     } <span class="keywordflow">else</span> 
<a name="l00492"></a>00492       <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a0b55b90ff316db2264004f2131f09d20" title="Log TREX message.">log</a>(<span class="stringliteral">&quot;WARN&quot;</span>)&lt;&lt;<span class="stringliteral">&quot;Creation of &quot;</span>&lt;&lt;pred.<a class="code" href="../../d4/db5/classTREX_1_1transaction_1_1Predicate.html#a5e18c7846b0bfe674ccf60b5cf98aa9c" title="Predicate object.">object</a>()&lt;&lt;<span class="charliteral">&#39;.&#39;</span>&lt;&lt;pred.<a class="code" href="../../d4/db5/classTREX_1_1transaction_1_1Predicate.html#a028ede642074b939f4d3b2a27ca2c47a" title="predicate type">predicate</a>()
<a name="l00493"></a>00493                  &lt;&lt;<span class="stringliteral">&quot; resulted on an invalid token id&quot;</span>; 
<a name="l00494"></a>00494   } <span class="keywordflow">else</span> {
<a name="l00495"></a>00495     <span class="comment">// This token is unknown for the timeline  </span>
<a name="l00496"></a>00496     <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a0b55b90ff316db2264004f2131f09d20" title="Log TREX message.">log</a>(<span class="stringliteral">&quot;WARN&quot;</span>)&lt;&lt;<span class="stringliteral">&quot;Unknown predicate &quot;</span>&lt;&lt;pred.<a class="code" href="../../d4/db5/classTREX_1_1transaction_1_1Predicate.html#a028ede642074b939f4d3b2a27ca2c47a" title="predicate type">predicate</a>()
<a name="l00497"></a>00497                &lt;&lt;<span class="stringliteral">&quot; for the object &quot;</span>&lt;&lt;pred.<a class="code" href="../../d4/db5/classTREX_1_1transaction_1_1Predicate.html#a5e18c7846b0bfe674ccf60b5cf98aa9c" title="Predicate object.">object</a>();
<a name="l00498"></a>00498     <span class="keywordflow">if</span>( isFact ) {
<a name="l00499"></a>00499       <span class="comment">// If it is a fact I still need to create something </span>
<a name="l00500"></a>00500       <span class="comment">//     =&gt; create the &quot;undefined&quot; token</span>
<a name="l00501"></a>00501       pred_name = timeline-&gt;getType().toString()+<span class="stringliteral">&quot;.&quot;</span>+<a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a65d498ecdb1911fcf764c336c5dceae2" title="undefined predicate name">UNDEFINED_PRED</a>;
<a name="l00502"></a>00502       <span class="keywordflow">if</span>( <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#acefaf2dd910ec5609ad7c682649507f9" title="Get europa schema.">schema</a>()-&gt;isPredicate(pred_name.c_str()) ) {
<a name="l00503"></a>00503         token = cli-&gt;createToken(pred_name.c_str(), NULL, rejectable, isFact);
<a name="l00504"></a>00504       } <span class="keywordflow">else</span> {
<a name="l00505"></a>00505         <span class="comment">// I should never reach that place but handle the issue anyway</span>
<a name="l00506"></a>00506         std::ostringstream oss;
<a name="l00507"></a>00507         oss&lt;&lt;<span class="stringliteral">&quot;Unable to create special \&quot;&quot;</span>&lt;&lt;<a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a65d498ecdb1911fcf764c336c5dceae2" title="undefined predicate name">UNDEFINED_PRED</a>
<a name="l00508"></a>00508            &lt;&lt;<span class="stringliteral">&quot;\&quot; predicate for the object &quot;</span>&lt;&lt;timeline-&gt;getName().toString(); 
<a name="l00509"></a>00509         <span class="keywordflow">throw</span> <a class="code" href="../../dd/d3e/classTREX_1_1europa_1_1EuropaException.html" title="Europa related error.">EuropaException</a>(oss.str());
<a name="l00510"></a>00510       }
<a name="l00511"></a>00511     }
<a name="l00512"></a>00512   }
<a name="l00513"></a>00513   <span class="keywordflow">if</span>( token.isId() ) {
<a name="l00514"></a>00514     <span class="comment">// Ensure that the object is correctly set</span>
<a name="l00515"></a>00515     EUROPA::ConstrainedVariableId obj_var = token-&gt;getObject();
<a name="l00516"></a>00516     
<a name="l00517"></a>00517     obj_var-&gt;specify(timeline-&gt;getKey());
<a name="l00518"></a>00518   }
<a name="l00519"></a>00519   <span class="keywordflow">return</span> std::make_pair(timeline, token);
<a name="l00520"></a>00520 }
<a name="l00521"></a>00521 
<a name="l00522"></a>00522 <span class="keywordtype">void</span> Assembly::process_pending() {
<a name="l00523"></a>00523   agenda().process_pending(EUROPA::IntervalIntDomain(m_reactor.<a class="code" href="../../df/d7a/classTREX_1_1transaction_1_1TeleoReactor.html#a10b44ea7bbeb13a23528f82c3c7c78c3" title="reactor initial tick">getInitialTick</a>(),
<a name="l00524"></a>00524                                                      m_reactor.<a class="code" href="../../df/d7a/classTREX_1_1transaction_1_1TeleoReactor.html#aef17ce86509d19a00792feccbcf84a67" title="Get final tick.">getFinalTick</a>()));
<a name="l00525"></a>00525 }
<a name="l00526"></a>00526 
<a name="l00527"></a>00527 <span class="keywordtype">bool</span> Assembly::propagate() {
<a name="l00528"></a>00528   <span class="keywordflow">if</span>( invalid() ) 
<a name="l00529"></a>00529     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00530"></a>00530   <span class="keywordflow">if</span>( !m_cstr_engine-&gt;propagate() ) {
<a name="l00531"></a>00531     <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a0b55b90ff316db2264004f2131f09d20" title="Log TREX message.">log</a>(<span class="stringliteral">&quot;WARN&quot;</span>)&lt;&lt;<span class="stringliteral">&quot;Inconsitent plan (see &quot;</span>&lt;&lt;name()&lt;&lt;<span class="stringliteral">&quot;.europa.log for details).&quot;</span>;
<a name="l00532"></a>00532     log_propagation_failure();
<a name="l00533"></a>00533     mark_invalid();
<a name="l00534"></a>00534   }
<a name="l00535"></a>00535   <span class="keywordflow">return</span> !invalid();
<a name="l00536"></a>00536 }
<a name="l00537"></a>00537 
<a name="l00538"></a>00538 
<a name="l00539"></a>00539 <span class="keywordtype">bool</span> Assembly::synchronize(<a class="code" href="../../db/db4/group__transaction.html#ga71ccb7c46d43d3d538c401886b341ada" title="TREX unit of time.">TICK</a> exec_frontier) {
<a name="l00540"></a>00540   <span class="keywordflow">if</span>( m_clk.isId() ) {
<a name="l00541"></a>00541     m_clk-&gt;restrictBaseDomain(EUROPA::IntervalIntDomain(exec_frontier,
<a name="l00542"></a>00542                                                         std::numeric_limits&lt;EUROPA::eint&gt;::infinity()));
<a name="l00543"></a>00543   }
<a name="l00544"></a>00544 }
<a name="l00545"></a>00545 
<a name="l00546"></a>00546 
<a name="l00547"></a>00547 <span class="keywordtype">bool</span> Assembly::step() {
<a name="l00548"></a>00548   <span class="keywordflow">if</span>( propagate() ) { 
<a name="l00549"></a>00549     process_pending();
<a name="l00550"></a>00550     <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a1f28e61dc187fce2ba1950e3a179acf9" title="Get the solver.">solver</a>().step();
<a name="l00551"></a>00551     process_pending();
<a name="l00552"></a>00552     <span class="keywordflow">if</span>( <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a1f28e61dc187fce2ba1950e3a179acf9" title="Get the solver.">solver</a>().noMoreFlaws() ) {
<a name="l00553"></a>00553       debugMsg(<span class="stringliteral">&quot;trex:step&quot;</span>, <span class="stringliteral">&quot;Solution found (No more flaws).&quot;</span>);
<a name="l00554"></a>00554       m_state = INACTIVE;
<a name="l00555"></a>00555       m_reactor.deliberation_completed();
<a name="l00556"></a>00556     }
<a name="l00557"></a>00557     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00558"></a>00558   } <span class="keywordflow">else</span> {
<a name="l00559"></a>00559     debugMsg(<span class="stringliteral">&quot;trex:step&quot;</span>, <span class="stringliteral">&quot;Propagation failure.&quot;</span>);
<a name="l00560"></a>00560     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00561"></a>00561   }
<a name="l00562"></a>00562 }
<a name="l00563"></a>00563 
<a name="l00564"></a>00564 <span class="keywordtype">bool</span> Assembly::relax(<a class="code" href="../../db/db4/group__transaction.html#ga71ccb7c46d43d3d538c401886b341ada" title="TREX unit of time.">TICK</a> exec_frontier, <span class="keywordtype">bool</span> aggressive) {
<a name="l00565"></a>00565   <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a0b55b90ff316db2264004f2131f09d20" title="Log TREX message.">log</a>(<span class="stringliteral">&quot;core&quot;</span>)&lt;&lt;<span class="stringliteral">&quot;Beginning&quot;</span>&lt;&lt;(aggressive?<span class="stringliteral">&quot; aggressive &quot;</span>:<span class="stringliteral">&quot; &quot;</span>)&lt;&lt;<span class="stringliteral">&quot;database relax.&quot;</span>;
<a name="l00566"></a>00566   
<a name="l00567"></a>00567   <span class="comment">// First reset my state </span>
<a name="l00568"></a>00568   <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a1f28e61dc187fce2ba1950e3a179acf9" title="Get the solver.">solver</a>().clear();
<a name="l00569"></a>00569   m_state = INACTIVE;
<a name="l00570"></a>00570   
<a name="l00571"></a>00571   
<a name="l00572"></a>00572   <span class="comment">// Here I try to get rid of all the tokens that can be in the way </span>
<a name="l00573"></a>00573   <span class="comment">//  1) observations </span>
<a name="l00574"></a>00574   
<a name="l00575"></a>00575   <span class="keywordflow">return</span> propagate();
<a name="l00576"></a>00576 }
<a name="l00577"></a>00577 
<a name="l00578"></a>00578 
<a name="l00579"></a>00579 <span class="comment">// modifiers</span>
<a name="l00580"></a>00580 
<a name="l00581"></a>00581 <span class="keywordtype">void</span> Assembly::mark_active() {
<a name="l00582"></a>00582   <span class="keywordflow">if</span>( !( invalid() || active() )  ) {
<a name="l00583"></a>00583     debugMsg(<span class="stringliteral">&quot;trex:assembly&quot;</span>, <span class="stringliteral">&quot;Deliberation is marked ACTIVE&quot;</span>);
<a name="l00584"></a>00584     m_state = ACTIVE;
<a name="l00585"></a>00585   }
<a name="l00586"></a>00586 }
<a name="l00587"></a>00587 
<a name="l00588"></a>00588 <span class="keywordtype">void</span> Assembly::mark_invalid() {
<a name="l00589"></a>00589   <span class="keywordflow">if</span>( !invalid() ) {
<a name="l00590"></a>00590     debugMsg(<span class="stringliteral">&quot;trex:assembly&quot;</span>, <span class="stringliteral">&quot;Deliberation is marked INVALID&quot;</span>);
<a name="l00591"></a>00591     m_state = INVALID;
<a name="l00592"></a>00592   }
<a name="l00593"></a>00593 }
<a name="l00594"></a>00594 
<a name="l00595"></a>00595 
<a name="l00596"></a>00596 <span class="keywordtype">void</span> <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a6d82ffc764606b37fce35a1d77fa9f18" title="Set as ignored object.">Assembly::ignore</a>(EUROPA::ObjectId <span class="keyword">const</span> &amp;obj) {
<a name="l00597"></a>00597   debugMsg(<span class="stringliteral">&quot;trex:assembly&quot;</span>, <span class="stringliteral">&quot;Marking &quot;</span>&lt;&lt;obj-&gt;getName().toString()&lt;&lt;<span class="stringliteral">&quot; as Ignored.&quot;</span>);
<a name="l00598"></a>00598   m_ignored_objs.insert(obj);  
<a name="l00599"></a>00599 }
<a name="l00600"></a>00600 
<a name="l00601"></a>00601 <span class="keywordtype">void</span> <a class="code" href="../../dc/d76/classTREX_1_1europa_1_1Assembly.html#a6d82ffc764606b37fce35a1d77fa9f18" title="Set as ignored object.">Assembly::ignore</a>(EUROPA::TokenId <span class="keyword">const</span> &amp;tok) {
<a name="l00602"></a>00602   debugMsg(<span class="stringliteral">&quot;trex:assembly&quot;</span>, <span class="stringliteral">&quot;Marking &quot;</span>&lt;&lt;tok-&gt;getName().toString()&lt;&lt;<span class="stringliteral">&quot; as Ignored.&quot;</span>);
<a name="l00603"></a>00603   m_ignored_toks.insert(tok);  
<a name="l00604"></a>00604 }
<a name="l00605"></a>00605 
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Wed Dec 14 14:40:10 2011 for trex by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
